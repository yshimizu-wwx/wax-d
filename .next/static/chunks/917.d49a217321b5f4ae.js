"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[917],{1768:function(e,t,l){l.r(t),l.d(t,{default:function(){return j}});var r=l(3827),a=l(4090),n=l(3614),o=l(6052),s=l(7378),i=l(6461),u=l.n(i);l(9851),l(3623);var d=l(47),c=l(9079);async function m(e){var t,l;let r=c.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;if(!(null==r?void 0:r.trim()))return null;let a=null==e?void 0:e.trim();if(!a)return null;let n=new URLSearchParams({address:a,key:r,region:"jp",language:"ja"}),o=await fetch("".concat("https://maps.googleapis.com/maps/api/geocode/json","?").concat(n.toString()));if(!o.ok)return null;let s=await o.json();if("OK"!==s.status&&"ZERO_RESULTS"!==s.status||!(null===(t=s.results)||void 0===t?void 0:t.length))return null;let i=s.results[0],u=null===(l=i.geometry)||void 0===l?void 0:l.location;return u&&"number"==typeof u.lat&&"number"==typeof u.lng?{lat:u.lat,lng:u.lng,displayName:i.formatted_address}:null}var f=l(9079);function g(e){let t=e.trim();return!!(/日本|Japan|にほん|ニホン/i.test(t)||/[一-龥ぁ-んァ-ン]/.test(t)||/県|府|都|道|郡|町|村|市|区|丁目|番地/.test(t))}function p(e){let t=e.trim();return!g(t)||/日本|Japan/i.test(t)?t:"".concat(t,", Japan")}async function h(e){let t=null==e?void 0:e.trim();if(!t)return null;if(f.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY){let e=await m(t);if(e)return{lat:e.lat,lng:e.lng,displayName:e.displayName}}let l=p(t),r=new URLSearchParams({q:l,format:"json",limit:"1",addressdetails:"0"});r.set("countrycodes","jp");let a=async()=>{let e=await fetch("".concat("https://nominatim.openstreetmap.org/search","?").concat(r.toString()),{method:"GET",headers:{Accept:"application/json","User-Agent":"WayfinderAgriX/1.0 (Agricultural field mapping)"}});if(!e.ok)return null;let t=await e.json();if(!Array.isArray(t)||0===t.length)return null;let l=t[0],a=parseFloat(l.lat),n=parseFloat(l.lon);return Number.isNaN(a)||Number.isNaN(n)?null:{lat:a,lng:n,displayName:l.display_name}},n=await a();if(n||l===t||(r.set("q",t),await new Promise(e=>setTimeout(e,1100)),n=await a()),!n&&g(t)){let e=t.replace(/\s*[\d０-９\-－ー]+\s*$/,"").trim();e&&e.length>=2&&(r.set("q",p(e)),await new Promise(e=>setTimeout(e,1100)),n=await a())}return n}function y(e){switch(e){case 1:return"位置情報が許可されていません。ブラウザの設定で位置情報を許可するか、住所で検索してください。";case 2:return"位置情報を取得できませんでした。ネットワークや設定を確認して再試行してください。";case 3:return"位置情報の取得がタイムアウトしました。もう一度お試しください。";default:return"位置情報を利用できません。住所で検索してください。"}}var x=l(1004),v=l(8561),b=l(2999);l(8506),delete u().Icon.Default.prototype._getIconUrl,u().Icon.Default.mergeOptions({iconUrl:v.Z.src,iconRetinaUrl:x.Z.src,shadowUrl:b.Z.src});let w=[35.6812,139.7671];function E(e){let{onPolygonComplete:t,initialPolygon:l,flyTo:r}=e,o=(0,n.Sx)(),s=(0,a.useRef)(new(u()).FeatureGroup),i=(0,a.useRef)(null);return(0,a.useEffect)(()=>{if(!r)return;let e="".concat(r[0],",").concat(r[1]);i.current!==e&&(i.current=e,o.flyTo([r[0],r[1]],15,{duration:.5}))},[o,r]),(0,a.useEffect)(()=>{let e=s.current;if(o.addLayer(e),l&&l.length>2){let t=u().polygon(l,{color:"#1A4731",fillColor:"#1A4731",fillOpacity:.25,weight:3});e.addLayer(t),o.fitBounds(t.getBounds())}let r=new(u()).Control.Draw({draw:{polygon:{allowIntersection:!1,showArea:!0,shapeOptions:{color:"#1A4731",fillColor:"#1A4731",fillOpacity:.25,weight:3}},rectangle:!1,circle:!1,marker:!1,polyline:!1,circlemarker:!1},edit:{featureGroup:e,remove:!0,edit:!1}});return o.addControl(r),o.on(u().Draw.Event.CREATED,l=>{let r=l.layer;e.clearLayers(),e.addLayer(r);let a=r.getLatLngs()[0].map(e=>({lat:e.lat,lng:e.lng})),n=(0,d.nn)(r);t(a,(0,d.fw)(n),n)}),o.on(u().Draw.Event.DELETED,()=>{t(null,0,null)}),()=>{o.removeControl(r),o.removeLayer(e),o.off(u().Draw.Event.CREATED),o.off(u().Draw.Event.DELETED)}},[o,t,l]),null}function j(e){var t;let{initialCenter:l,initialAddress:n,showAddressSearch:i=!1}=e,[u,d]=(0,a.useState)(null),[c,m]=(0,a.useState)(""),[f,g]=(0,a.useState)(!1),[p,x]=(0,a.useState)(null),[v,b]=(0,a.useState)(null),[j,N]=(0,a.useState)(!1),A=(0,a.useRef)(!1),C=(0,a.useRef)(!1),{getCurrentPosition:T,loading:k,error:_,clearError:S}=function(){let[e,t]=(0,a.useState)(!1),[l,r]=(0,a.useState)(null);return{getCurrentPosition:(0,a.useCallback)(()=>{var e;return(null===(e=navigator)||void 0===e?void 0:e.geolocation)?(r(null),t(!0),new Promise(e=>{let l=setTimeout(()=>{t(!1),r({code:3,message:"Timeout",userFriendlyMessage:y(3)}),e(null)},1e4);navigator.geolocation.getCurrentPosition(a=>{clearTimeout(l),t(!1),r(null),e({lat:a.coords.latitude,lng:a.coords.longitude})},a=>{var n,o;clearTimeout(l),t(!1);let s=null!==(n=null==a?void 0:a.code)&&void 0!==n?n:0;r({code:s,message:null!==(o=null==a?void 0:a.message)&&void 0!==o?o:"Unknown",userFriendlyMessage:y(s)}),e(null)},{enableHighAccuracy:!0,timeout:8e3,maximumAge:5e3})})):(r({code:0,message:"Geolocation not supported",userFriendlyMessage:"お使いのブラウザでは位置情報を利用できません。住所で検索してください。"}),Promise.resolve(null))},[]),loading:e,error:l,clearError:()=>r(null)}}(),L=null!==(t=null!=l?l:v)&&void 0!==t?t:w,D=!l&&!!(null==n?void 0:n.trim())&&null===v;(0,a.useEffect)(()=>{let e=null==n?void 0:n.trim();e&&!C.current&&(C.current=!0,m(e))},[n]),(0,a.useEffect)(()=>{(null==n?void 0:n.trim())&&null==l&&!A.current&&(A.current=!0,h(n.trim()).then(e=>{if(e){let t=[e.lat,e.lng];b(t),d(t),N(!0),setTimeout(()=>N(!1),600)}else b(w)}))},[n,l]);let P=(0,a.useCallback)(async()=>{let e=c.trim();if(e){g(!0),x(null),S();try{let t=await h(e);t?(d([t.lat,t.lng]),N(!0),setTimeout(()=>N(!1),600)):x("住所が見つかりませんでした。別のキーワードで試してください。")}catch(e){x("検索に失敗しました。しばらくしてから再試行してください。")}finally{g(!1)}}},[c,S]),R=(0,a.useCallback)(async()=>{x(null),S();let e=await T();e&&(d([e.lat,e.lng]),N(!0),setTimeout(()=>N(!1),600))},[T,S]);return(0,r.jsxs)("div",{className:"w-full h-full flex flex-col min-h-0",children:[i&&(0,r.jsxs)("div",{className:"shrink-0 flex flex-wrap gap-2 mb-2",children:[(0,r.jsx)("input",{type:"text",value:c,onChange:e=>{m(e.target.value),x(null),S()},onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),P()),placeholder:"住所で検索（例: 東京都千代田区）",className:"flex-1 min-w-[160px] px-3 py-2 text-sm bg-dashboard-bg border border-dashboard-border rounded-lg outline-none focus:ring-2 focus:ring-agrix-forest text-dashboard-text placeholder:text-dashboard-muted"}),(0,r.jsx)("button",{type:"button",onClick:P,disabled:f,className:"px-4 py-2 text-sm font-medium rounded-lg bg-agrix-forest hover:bg-agrix-forest-dark text-white disabled:opacity-50",children:f?"検索中...":"地図を移動"}),(0,r.jsx)("button",{type:"button",onClick:R,disabled:k,className:"px-4 py-2 text-sm font-medium rounded-lg border border-dashboard-border bg-dashboard-card hover:bg-dashboard-bg text-dashboard-text disabled:opacity-50",title:"現在地へ移動",children:k?"取得中...":"現在地"}),(p||_)&&(0,r.jsx)("p",{className:"w-full text-xs text-destructive",children:p||(null==_?void 0:_.userFriendlyMessage)})]}),(0,r.jsx)("div",{className:"flex-1 min-h-0 rounded-lg overflow-hidden relative",children:D?(0,r.jsx)("div",{className:"w-full h-full min-h-[400px] rounded-lg bg-dashboard-card flex items-center justify-center text-dashboard-muted text-sm",children:"拠点住所から地図を読み込み中..."}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(o.h,{center:L,zoom:15,style:{height:"100%",width:"100%",minHeight:"400px",borderRadius:"0.5rem"},children:[(0,r.jsx)(s.I,{attribution:'\xa9 <a href="https://www.google.com/maps">Google</a>',url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",maxZoom:20}),(0,r.jsx)(E,{...e,flyTo:u})]}),j&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none rounded-lg bg-black/20",children:(0,r.jsx)("span",{className:"px-3 py-2 text-sm font-medium rounded-lg bg-dashboard-card text-dashboard-text shadow",children:"移動中..."})})]})})]})}}}]);