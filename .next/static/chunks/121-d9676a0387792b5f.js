"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[121],{8222:function(e,r,t){t.d(r,{TB:function(){return l},dm:function(){return _},g8:function(){return o},mK:function(){return d},ss:function(){return s},v2:function(){return c},x1:function(){return u}});var n=t(4958),a=t(47),i=t(407);async function o(){let{data:e,error:r}=await n.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1}).limit(1).single();return r?("PGRST116"===r.code?console.log("No active project found"):console.error("Error fetching active project:",r),null):e}async function c(){let{data:e,error:r}=await n.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1});return r?(console.error("Error fetching open campaigns:",r),[]):e||[]}async function s(e){let{data:r,error:t}=await n.O.from("bookings").select("id, campaign_id, area_10r, status, work_status, locked_price, created_at").eq("farmer_id",e).order("created_at",{ascending:!1});if(t)return console.error("Error fetching farmer bookings:",t),[];let a=r||[];if(0===a.length)return[];let i=[...new Set(a.map(e=>e.campaign_id))],{data:o}=await n.O.from("projects").select("id, location, campaign_title, start_date, end_date, status, is_closed").in("id",i),c=new Map;return(o||[]).forEach(e=>{c.set(e.id,{id:e.id,location:e.location||"",campaign_title:e.campaign_title,start_date:e.start_date,end_date:e.end_date,status:e.status,is_closed:e.is_closed})}),a.map(e=>({id:e.id,campaign_id:e.campaign_id,area_10r:Number(e.area_10r)||0,status:e.status||"",work_status:e.work_status,locked_price:null!=e.locked_price?Number(e.locked_price):void 0,created_at:e.created_at,project:c.get(e.campaign_id)}))}async function u(e){let{data:r,error:t}=await n.O.from("bookings").select("area_10r").eq("campaign_id",e).neq("status","canceled");return t?(console.error("Error fetching campaign total area:",t),0):(null==r?void 0:r.reduce((e,r)=>e+(r.area_10r||0),0))||0}async function l(e){try{let{data:t,error:o}=await n.O.from("projects").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",e.campaign_id).single();if(o||!t)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(t))return{success:!1,error:"この案件は募集終了しています"};let c=await u(e.campaign_id),s=Number(t.max_target_area_10r)>0?Number(t.max_target_area_10r):Number(t.target_area_10r)||1,l=(0,i.ae)(e.area_10r,c,s);if(!l.isValid){var r;return{success:!1,error:null!==(r=l.errorMessage)&&void 0!==r?r:"申込面積が上限を超えています"}}let d=(0,a.NO)(e.field_polygon),_="BK_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),g={id:_,campaign_id:e.campaign_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:d,area_10r:e.area_10r,locked_price:e.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=e.farmer_id&&""!==e.farmer_id&&(g.farmer_id=e.farmer_id);let{data:m,error:f}=await n.O.from("bookings").insert(g).select("id").single();if(f)return console.error("Error creating booking:",f),{success:!1,error:f.message};return{success:!0,bookingId:(null==m?void 0:m.id)||_}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function d(e,r){try{var t,i,o;let c=(0,a.NO)(e.targetAreaPolygon),s="C_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),{data:u,error:l}=await n.O.from("projects").insert({id:s,provider_id:r||null,location:e.location,start_date:e.startDate,end_date:e.endDate,target_crop_id:e.cropId||null,task_category_id:e.categoryId||null,task_detail_id:e.detailId||null,pesticide_name:e.pesticide||null,dilution_rate:e.dilutionRate?parseFloat(e.dilutionRate):null,amount_per_10r:e.amountPer10r?parseFloat(e.amountPer10r):null,base_price:e.basePrice,min_price:e.minPrice,min_target_area_10r:e.minTargetArea10r||null,target_area_10r:e.targetArea10r,max_target_area_10r:null!==(i=null!==(t=e.maxTargetArea10r)&&void 0!==t?t:e.targetArea10r)&&void 0!==i?i:null,execution_price:null!==(o=e.executionPrice)&&void 0!==o?o:null,confirmation_deadline_days:e.confirmationDeadlineDays||null,target_area_polygon:c,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(l)return console.error("Error creating campaign:",l),{success:!1,error:l.message};return{success:!0,campaignId:(null==u?void 0:u.id)||s}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function _(e){var r,t;let{data:a,error:o}=await n.O.from("projects").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",e).single();if(o||!a)return{success:!1,error:"案件が見つかりません"};let c=await u(e),s={base_price:Number(a.base_price)||0,min_price:Number(a.min_price)||0,target_area_10r:Number(a.target_area_10r)||0,min_target_area_10r:a.min_target_area_10r,max_target_area_10r:a.max_target_area_10r,execution_price:a.execution_price},l=null!==(t=null!==(r=(0,i.Bx)(s,c).currentPrice)&&void 0!==r?r:s.min_price||s.base_price)&&void 0!==t?t:0,{error:d}=await n.O.from("projects").update({status:"closed",is_closed:!0,final_unit_price:l}).eq("id",e);if(d)return{success:!1,error:d.message};let{error:_}=await n.O.from("bookings").update({locked_price:l}).eq("campaign_id",e).neq("status","canceled");return _?{success:!1,error:_.message}:{success:!0}}},8793:function(e,r,t){t.d(r,{ts:function(){return a},w7:function(){return i}});var n=t(4958);async function a(){try{let{data:{session:e}}=await n.O.auth.getSession();if(!e)return null;let{data:r,error:t}=await n.O.from("users").select("*").eq("email",e.user.email).single();if(t||!r)return null;return r}catch(e){return console.error("Error getting current user:",e),null}}async function i(){await n.O.auth.signOut(),window.location.href="/login"}},407:function(e,r,t){function n(e,r){let{base_price:t,min_price:n,target_area_10r:a,min_target_area_10r:i=0,max_target_area_10r:o,execution_price:c}=e;if(t<n)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return i>0&&o&&o>0&&c?function(e,r){let{base_price:t,min_price:n,min_target_area_10r:a,max_target_area_10r:i,execution_price:o}=e;if(r<a){let e=a-r;return{currentPrice:null,progress:r/a,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=i)return{currentPrice:Math.round(n),progress:1,isUnformed:!1,priceReduction:t-n,remainingArea:0,nextMilestoneArea:0};let c=(r-a)/(i-a),s=o+(n-o)*c,u=i-r;return{currentPrice:Math.round(s),progress:c,isUnformed:!1,priceReduction:t-s,remainingArea:u,nextMilestoneArea:u}}(e,r):function(e,r){let{base_price:t,min_price:n,target_area_10r:a}=e,i=Math.min(r/a,1),o=t-(t-n)*i,c=Math.max(0,a-r);return{currentPrice:Math.round(o),progress:i,isUnformed:!1,priceReduction:t-o,remainingArea:c,nextMilestoneArea:c>0?c:void 0}}(e,r)}function a(e,r){if(e<0||r<0)throw Error("単価と実績面積は0以上である必要があります");return Math.round(e*r)}function i(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;if(e<0)throw Error("税抜金額は0以上である必要があります");if(r<0||r>100)throw Error("消費税率は0〜100%の範囲である必要があります");let t=Math.round(r/100*e);return{amountExTax:e,taxAmount:t,amountInclusive:e+t,taxRate:r}}function o(e,r,t){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:t-r,maxArea:t};let n=t-r;return e>n?{isValid:!1,errorMessage:"申し込み面積が上限を超えています。残り ".concat(n.toFixed(1)," 反まで予約可能です。"),currentTotalArea:r,remainingArea:n,maxArea:t}:{isValid:!0,currentTotalArea:r,remainingArea:n,maxArea:t}}t.d(r,{Bx:function(){return n},MR:function(){return a},ae:function(){return o},km:function(){return i}})},47:function(e,r,t){t.d(r,{NO:function(){return o},fw:function(){return a},nn:function(){return i}});var n=t(8011);function a(e){return Math.round(n.SOn(e)/991.7355*100)/100}function i(e){return function(e){let r=[...e];return r.length>=4&&r[0][0]===r[r.length-1][0]&&r[0][1]===r[r.length-1][1]||r.push(r[0]),{type:"Polygon",coordinates:[r]}}(e.getLatLngs()[0].map(e=>[e.lng,e.lat]))}function o(e){let r=e.coordinates[0].map(e=>{let[r,t]=e;return"".concat(r," ").concat(t)}).join(", ");return"POLYGON((".concat(r,"))")}},4958:function(e,r,t){t.d(r,{O:function(){return n}});let n=(0,t(6070).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","sb_publishable_saY21TLJVLBNk5lg53j5Pg_PW9RAlEr")}}]);