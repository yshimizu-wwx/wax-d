"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[281],{5671:function(e,r,t){t.d(r,{Ol:function(){return s},SZ:function(){return l},Zb:function(){return o},aY:function(){return d},ll:function(){return c}});var n=t(3827),a=t(4090),i=t(2169);let o=a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("div",{ref:r,className:(0,i.cn)("rounded-xl border border-border bg-card text-card-foreground shadow-sm transition-all duration-200 hover:shadow-md",t),...a})});o.displayName="Card";let s=a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("div",{ref:r,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",t),...a})});s.displayName="CardHeader";let c=a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("h3",{ref:r,className:(0,i.cn)("text-lg font-bold leading-none tracking-tight text-card-foreground",t),...a})});c.displayName="CardTitle";let l=a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("p",{ref:r,className:(0,i.cn)("text-sm text-muted-foreground",t),...a})});l.displayName="CardDescription";let d=a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("div",{ref:r,className:(0,i.cn)("p-6 pt-0",t),...a})});d.displayName="CardContent",a.forwardRef((e,r)=>{let{className:t,...a}=e;return(0,n.jsx)("div",{ref:r,className:(0,i.cn)("flex items-center p-6 pt-0",t),...a})}).displayName="CardFooter"},4656:function(e,r,t){t.d(r,{dm:function(){return b},TB:function(){return h},mK:function(){return k},Gr:function(){return M},xC:function(){return O},AK:function(){return R},ss:function(){return w},x1:function(){return x},cd:function(){return q},ye:function(){return N},v2:function(){return y},xW:function(){return E},L4:function(){return A}});var n=t(4958),a=t(47),i=t(407);async function o(e){let{data:r,error:t}=await e.from("campaigns").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1});return t?(console.error("Error fetching open campaigns:",t),[]):null!=r?r:[]}async function s(e,r){let{data:t,error:n}=await e.from("bookings").select("area_10r").eq("campaign_id",r).neq("status","canceled");return n?(console.error("Error fetching campaign total area:",n),0):(null!=t?t:[]).reduce((e,r)=>e+(Number(null==r?void 0:r.area_10r)||0),0)}async function c(e,r,t){try{var n,i,o,s;let c=(0,a.NO)(r.targetAreaPolygon),l=crypto.randomUUID(),{data:d,error:u}=await e.from("campaigns").insert({id:l,provider_id:null!=t?t:null,location:r.location,start_date:r.startDate,end_date:r.endDate,target_crop_id:r.cropId||null,task_category_id:r.categoryId||null,task_detail_id:r.detailId||null,pesticide_name:r.pesticide||null,dilution_rate:r.dilutionRate?parseFloat(r.dilutionRate):null,amount_per_10r:r.amountPer10r?parseFloat(r.amountPer10r):null,base_price:r.basePrice,min_price:r.minPrice,min_target_area_10r:r.minTargetArea10r||null,target_area_10r:r.targetArea10r,max_target_area_10r:null!==(i=null!==(n=r.maxTargetArea10r)&&void 0!==n?n:r.targetArea10r)&&void 0!==i?i:null,execution_price:null!==(o=r.executionPrice)&&void 0!==o?o:null,confirmation_deadline_days:r.confirmationDeadlineDays||null,target_area_polygon:c,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(u)return console.error("Error creating campaign:",u),{success:!1,error:u.message};return{success:!0,campaignId:null!==(s=null==d?void 0:d.id)&&void 0!==s?s:l}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function l(e,r){var t,n,a,o,c,l;let{data:d,error:u}=await e.from("campaigns").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",r).single();if(u||!d)return{success:!1,error:"案件が見つかりません"};let _=await s(e,r),f={base_price:Number(d.base_price)||0,min_price:Number(d.min_price)||0,target_area_10r:Number(d.target_area_10r)||0,min_target_area_10r:null!==(t=d.min_target_area_10r)&&void 0!==t?t:void 0,max_target_area_10r:null!==(n=d.max_target_area_10r)&&void 0!==n?n:void 0,execution_price:null!==(a=d.execution_price)&&void 0!==a?a:void 0},m=null!==(l=null!==(c=null!==(o=(0,i.Bx)(f,_).currentPrice)&&void 0!==o?o:f.min_price)&&void 0!==c?c:f.base_price)&&void 0!==l?l:0,{error:g}=await e.from("campaigns").update({status:"closed",is_closed:!0,final_unit_price:m}).eq("id",r);if(g)return{success:!1,error:g.message};let{error:p}=await e.from("bookings").update({locked_price:m}).eq("campaign_id",r).neq("status","canceled");return p?{success:!1,error:p.message}:{success:!0}}async function d(e,r){let{data:t,error:n}=await e.from("bookings").select("id, campaign_id, area_10r, status, work_status, locked_price, created_at").eq("farmer_id",r).order("created_at",{ascending:!1});if(n)return console.error("Error fetching farmer bookings:",n),[];let a=null!=t?t:[];if(0===a.length)return[];let i=[...new Set(a.map(e=>e.campaign_id))],{data:o}=await e.from("campaigns").select("id, location, campaign_title, start_date, end_date, status, is_closed").in("id",i),s=new Map;return(null!=o?o:[]).forEach(e=>{var r;s.set(e.id,{id:e.id,location:null!==(r=e.location)&&void 0!==r?r:"",campaign_title:e.campaign_title,start_date:e.start_date,end_date:e.end_date,status:e.status,is_closed:e.is_closed})}),a.map(e=>{var r;return{id:e.id,campaign_id:e.campaign_id,area_10r:Number(e.area_10r)||0,status:null!==(r=e.status)&&void 0!==r?r:"",work_status:e.work_status,locked_price:null!=e.locked_price?Number(e.locked_price):void 0,created_at:e.created_at,project:s.get(e.campaign_id)}})}async function u(e,r){try{var t,n;let{data:o,error:c}=await e.from("campaigns").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",r.campaign_id).single();if(c||!o)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(o))return{success:!1,error:"この案件は募集終了しています"};let l=await s(e,r.campaign_id),d=Number(o.max_target_area_10r)>0?Number(o.max_target_area_10r):Number(o.target_area_10r)||1,u=(0,i.ae)(r.area_10r,l,d);if(!u.isValid)return{success:!1,error:null!==(t=u.errorMessage)&&void 0!==t?t:"申込面積が上限を超えています"};let _=(0,a.NO)(r.field_polygon),f="BK_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,11)),m={id:f,campaign_id:r.campaign_id,farmer_name:r.farmer_name,phone:r.phone,email:r.email,desired_start_date:r.desired_start_date,desired_end_date:r.desired_end_date,field_polygon:_,area_10r:r.area_10r,locked_price:r.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=r.farmer_id&&""!==r.farmer_id&&(m.farmer_id=r.farmer_id);let{data:g,error:p}=await e.from("bookings").insert(m).select("id").single();if(p)return console.error("Error creating booking:",p),{success:!1,error:p.message};return{success:!0,bookingId:null!==(n=null==g?void 0:g.id)&&void 0!==n?n:f}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function _(e,r){let{data:t,error:n}=await e.from("fields").select("*").eq("farmer_id",r).order("created_at",{ascending:!1});return n?(console.error("Error fetching fields:",n),[]):null!=t?t:[]}async function f(e,r){try{var t,n,a,i,o,s;let c="F_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,11)),{data:l,error:d}=await e.from("fields").insert({id:c,farmer_id:r.farmer_id,name:null!==(t=r.name)&&void 0!==t?t:null,address:null!==(n=r.address)&&void 0!==n?n:null,area_size:null!==(a=r.area_size)&&void 0!==a?a:null,lat:null!==(i=r.lat)&&void 0!==i?i:null,lng:null!==(o=r.lng)&&void 0!==o?o:null}).select("id").single();if(d)return console.error("Error creating field:",d),{success:!1,error:d.message};return{success:!0,fieldId:null!==(s=null==l?void 0:l.id)&&void 0!==s?s:c}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e,r,t){let n={};void 0!==t.name&&(n.name=t.name),void 0!==t.address&&(n.address=t.address),void 0!==t.area_size&&(n.area_size=t.area_size),void 0!==t.lat&&(n.lat=t.lat),void 0!==t.lng&&(n.lng=t.lng);let{error:a}=await e.from("fields").update(n).eq("id",r);return a?(console.error("Error updating field:",a),{success:!1,error:a.message}):{success:!0}}async function g(e,r){let{error:t}=await e.from("fields").delete().eq("id",r);return t?(console.error("Error deleting field:",t),{success:!1,error:t.message}):{success:!0}}async function p(e,r){try{var t,n,a,i,o,s,c,l,d,u,_,f,m;let g="WR_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,11)),p={id:g,farmer_id:r.farmer_id,provider_id:r.provider_id,location:null!==(n=r.location)&&void 0!==n?n:null,crop_name:null!==(a=r.crop_name)&&void 0!==a?a:null,task_category_name:null!==(i=r.task_category_name)&&void 0!==i?i:null,task_detail_name:null!==(o=r.task_detail_name)&&void 0!==o?o:null,crop_name_free_text:null!==(s=r.crop_name_free_text)&&void 0!==s?s:null,task_category_free_text:null!==(c=r.task_category_free_text)&&void 0!==c?c:null,task_detail_free_text:null!==(l=r.task_detail_free_text)&&void 0!==l?l:null,desired_start_date:null!==(d=r.desired_start_date)&&void 0!==d?d:null,desired_end_date:null!==(u=r.desired_end_date)&&void 0!==u?u:null,estimated_area_10r:null!==(_=r.estimated_area_10r)&&void 0!==_?_:null,notes:null!==(f=r.notes)&&void 0!==f?f:null,status:"pending"};(null===(t=r.field_ids)||void 0===t?void 0:t.length)&&(p.field_ids=r.field_ids);let{data:v,error:y}=await e.from("work_requests").insert(p).select("id").single();if(y)return console.error("Error creating work request:",y),{success:!1,error:y.message};return{success:!0,requestId:null!==(m=null==v?void 0:v.id)&&void 0!==m?m:g}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function v(e,r){let{data:t,error:n}=await e.from("work_requests").select("*").eq("farmer_id",r).order("created_at",{ascending:!1});return n?(console.error("Error fetching work requests:",n),[]):null!=t?t:[]}async function y(){return o(n.O)}async function w(e){return d(n.O,e)}async function x(e){return s(n.O,e)}async function h(e){return u(n.O,{campaign_id:e.campaign_id,farmer_id:e.farmer_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:e.field_polygon,area_10r:e.area_10r,locked_price:e.locked_price})}async function k(e,r){return c(n.O,e,r)}async function b(e){return l(n.O,e)}async function N(e){var r;let{data:t}=await n.O.from("farmer_providers").select("provider_id").eq("farmer_id",e).eq("status","active"),a=null!==(r=null==t?void 0:t.map(e=>e.provider_id).filter(Boolean))&&void 0!==r?r:[];if(0===a.length)return[];let{data:i}=await n.O.from("users").select("id, name").in("id",a),o=new Map((null!=i?i:[]).map(e=>{var r;return[e.id,null!==(r=e.name)&&void 0!==r?r:e.id]}));return a.map(e=>{var r;return{id:e,name:null!==(r=o.get(e))&&void 0!==r?r:"業者"}})}async function O(e){return p(n.O,e)}async function E(e){return v(n.O,e)}async function q(e){return _(n.O,e)}async function M(e){return f(n.O,e)}async function A(e,r){return m(n.O,e,r)}async function R(e){return g(n.O,e)}},407:function(e,r,t){function n(e,r){let{base_price:t,min_price:n,target_area_10r:a,min_target_area_10r:i=0,max_target_area_10r:o,execution_price:s}=e;if(t<n)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return i>0&&o&&o>0&&s?function(e,r){let{base_price:t,min_price:n,min_target_area_10r:a,max_target_area_10r:i,execution_price:o}=e;if(r<a){let e=a-r;return{currentPrice:null,progress:r/a,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=i)return{currentPrice:Math.round(n),progress:1,isUnformed:!1,priceReduction:t-n,remainingArea:0,nextMilestoneArea:0};let s=(r-a)/(i-a),c=o+(n-o)*s,l=i-r;return{currentPrice:Math.round(c),progress:s,isUnformed:!1,priceReduction:t-c,remainingArea:l,nextMilestoneArea:l}}(e,r):function(e,r){let{base_price:t,min_price:n,target_area_10r:a}=e,i=Math.min(r/a,1),o=t-(t-n)*i,s=Math.max(0,a-r);return{currentPrice:Math.round(o),progress:i,isUnformed:!1,priceReduction:t-o,remainingArea:s,nextMilestoneArea:s>0?s:void 0}}(e,r)}function a(e,r){if(e<0||r<0)throw Error("単価と実績面積は0以上である必要があります");return Math.round(e*r)}function i(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;if(e<0)throw Error("税抜金額は0以上である必要があります");if(r<0||r>100)throw Error("消費税率は0〜100%の範囲である必要があります");let t=Math.round(r/100*e);return{amountExTax:e,taxAmount:t,amountInclusive:e+t,taxRate:r}}function o(e,r,t){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:t-r,maxArea:t};let n=t-r;return e>n?{isValid:!1,errorMessage:"申し込み面積が上限を超えています。残り ".concat(n.toFixed(1)," 反まで予約可能です。"),currentTotalArea:r,remainingArea:n,maxArea:t}:{isValid:!0,currentTotalArea:r,remainingArea:n,maxArea:t}}t.d(r,{Bx:function(){return n},MR:function(){return a},ae:function(){return o},km:function(){return i}})},47:function(e,r,t){t.d(r,{NO:function(){return o},RD:function(){return l},RX:function(){return c},a1:function(){return s},fw:function(){return a},nn:function(){return i}});var n=t(8011);function a(e){return Math.round(n.SOn(e)/991.7355*10)/10}function i(e){return function(e){let r=[...e];return r.length>=4&&r[0][0]===r[r.length-1][0]&&r[0][1]===r[r.length-1][1]||r.push(r[0]),{type:"Polygon",coordinates:[r]}}(e.getLatLngs()[0].map(e=>[e.lng,e.lat]))}function o(e){let r=e.coordinates[0].map(e=>{let[r,t]=e;return"".concat(r," ").concat(t)}).join(", ");return"POLYGON((".concat(r,"))")}function s(e){return{type:"Polygon",coordinates:[e.replace(/^POLYGON\(\(/,"").replace(/\)\)$/,"").split(", ").map(e=>{let[r,t]=e.split(" ").map(Number);return[r,t]})]}}function c(e){return n.beQ(e).geometry.coordinates}function l(e,r){try{let t=n.yue(e.coordinates),a=n.yue(r.coordinates),i=n.wfr(t,a);return null!=i}catch(e){return!1}}}}]);