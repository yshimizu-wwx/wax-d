"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[269,813],{6036:function(e,t,l){l.r(t),l.d(t,{default:function(){return x}});var n=l(3827),r=l(4090),a=l(3614),o=l(6052),u=l(7378),s=l(6461),i=l.n(s);l(9851),l(3623);var d=l(47),c=l(6763);function f(e){switch(e){case 1:return"位置情報が許可されていません。ブラウザの設定で位置情報を許可するか、住所で検索してください。";case 2:return"位置情報を取得できませんでした。ネットワークや設定を確認して再試行してください。";case 3:return"位置情報の取得がタイムアウトしました。もう一度お試しください。";default:return"位置情報を利用できません。住所で検索してください。"}}var m=l(1004),g=l(8561),p=l(2999);l(8506),delete i().Icon.Default.prototype._getIconUrl,i().Icon.Default.mergeOptions({iconUrl:g.Z.src,iconRetinaUrl:m.Z.src,shadowUrl:p.Z.src});let h=[35.6812,139.7671];function b(e){let{onPolygonComplete:t,initialPolygon:l,flyTo:n}=e,o=(0,a.Sx)(),u=(0,r.useRef)(new(i()).FeatureGroup),s=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!n)return;let e="".concat(n[0],",").concat(n[1]);s.current!==e&&(s.current=e,o.flyTo([n[0],n[1]],15,{duration:.5}))},[o,n]),(0,r.useEffect)(()=>{let e=u.current;if(o.addLayer(e),l&&l.length>2){let t=i().polygon(l,{color:"#1A4731",fillColor:"#1A4731",fillOpacity:.25,weight:3});e.addLayer(t),o.fitBounds(t.getBounds())}let n=new(i()).Control.Draw({draw:{polygon:{allowIntersection:!1,showArea:!0,shapeOptions:{color:"#1A4731",fillColor:"#1A4731",fillOpacity:.25,weight:3}},rectangle:!1,circle:!1,marker:!1,polyline:!1,circlemarker:!1},edit:{featureGroup:e,remove:!0,edit:!1}});return o.addControl(n),o.on(i().Draw.Event.CREATED,l=>{let n=l.layer;e.clearLayers(),e.addLayer(n);let r=n.getLatLngs()[0].map(e=>({lat:e.lat,lng:e.lng})),a=(0,d.nn)(n);t(r,(0,d.fw)(a),a)}),o.on(i().Draw.Event.DELETED,()=>{t(null,0,null)}),()=>{o.removeControl(n),o.removeLayer(e),o.off(i().Draw.Event.CREATED),o.off(i().Draw.Event.DELETED)}},[o,t,l]),null}function x(e){var t;let{initialCenter:l,initialAddress:a,showAddressSearch:s=!1}=e,[i,d]=(0,r.useState)(null),[m,g]=(0,r.useState)(""),[p,x]=(0,r.useState)(!1),[y,v]=(0,r.useState)(null),[w,E]=(0,r.useState)(null),[N,C]=(0,r.useState)(!1),j=(0,r.useRef)(!1),k=(0,r.useRef)(!1),{getCurrentPosition:D,loading:T,error:R,clearError:A}=function(){let[e,t]=(0,r.useState)(!1),[l,n]=(0,r.useState)(null);return{getCurrentPosition:(0,r.useCallback)(()=>{var e;return(null===(e=navigator)||void 0===e?void 0:e.geolocation)?(n(null),t(!0),new Promise(e=>{let l=setTimeout(()=>{t(!1),n({code:3,message:"Timeout",userFriendlyMessage:f(3)}),e(null)},1e4);navigator.geolocation.getCurrentPosition(r=>{clearTimeout(l),t(!1),n(null),e({lat:r.coords.latitude,lng:r.coords.longitude})},r=>{var a,o;clearTimeout(l),t(!1);let u=null!==(a=null==r?void 0:r.code)&&void 0!==a?a:0;n({code:u,message:null!==(o=null==r?void 0:r.message)&&void 0!==o?o:"Unknown",userFriendlyMessage:f(u)}),e(null)},{enableHighAccuracy:!0,timeout:8e3,maximumAge:5e3})})):(n({code:0,message:"Geolocation not supported",userFriendlyMessage:"お使いのブラウザでは位置情報を利用できません。住所で検索してください。"}),Promise.resolve(null))},[]),loading:e,error:l,clearError:()=>n(null)}}(),L=null!==(t=null!=l?l:w)&&void 0!==t?t:h,S=!l&&!!(null==a?void 0:a.trim())&&null===w;(0,r.useEffect)(()=>{let e=null==a?void 0:a.trim();e&&!k.current&&(k.current=!0,g(e))},[a]),(0,r.useEffect)(()=>{(null==a?void 0:a.trim())&&null==l&&!j.current&&(j.current=!0,(0,c.V)(a.trim()).then(e=>{if(e){let t=[e.lat,e.lng];E(t),d(t),C(!0),setTimeout(()=>C(!1),600)}else E(h)}))},[a,l]);let I=(0,r.useCallback)(async()=>{let e=m.trim();if(e){x(!0),v(null),A();try{let t=await (0,c.V)(e);t?(d([t.lat,t.lng]),C(!0),setTimeout(()=>C(!1),600)):v("住所が見つかりませんでした。別のキーワードで試してください。")}catch(e){v("検索に失敗しました。しばらくしてから再試行してください。")}finally{x(!1)}}},[m,A]),U=(0,r.useCallback)(async()=>{v(null),A();let e=await D();e&&(d([e.lat,e.lng]),C(!0),setTimeout(()=>C(!1),600))},[D,A]);return(0,n.jsxs)("div",{className:"w-full h-full flex flex-col min-h-0",children:[s&&(0,n.jsxs)("div",{className:"shrink-0 flex flex-wrap gap-2 mb-2",children:[(0,n.jsx)("input",{type:"text",value:m,onChange:e=>{g(e.target.value),v(null),A()},onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),I()),placeholder:"住所で検索（例: 東京都千代田区）",className:"flex-1 min-w-[160px] px-3 py-2 text-sm bg-dashboard-bg border border-dashboard-border rounded-lg outline-none focus:ring-2 focus:ring-agrix-forest text-dashboard-text placeholder:text-dashboard-muted"}),(0,n.jsx)("button",{type:"button",onClick:I,disabled:p,className:"px-4 py-2 text-sm font-medium rounded-lg bg-agrix-forest hover:bg-agrix-forest-dark text-white disabled:opacity-50",children:p?"検索中...":"地図を移動"}),(0,n.jsx)("button",{type:"button",onClick:U,disabled:T,className:"px-4 py-2 text-sm font-medium rounded-lg border border-dashboard-border bg-dashboard-card hover:bg-dashboard-bg text-dashboard-text disabled:opacity-50",title:"現在地へ移動",children:T?"取得中...":"現在地"}),(y||R)&&(0,n.jsx)("p",{className:"w-full text-xs text-destructive",children:y||(null==R?void 0:R.userFriendlyMessage)})]}),(0,n.jsx)("div",{className:"flex-1 min-h-0 rounded-lg overflow-hidden relative",children:S?(0,n.jsx)("div",{className:"w-full h-full min-h-[400px] rounded-lg bg-dashboard-card flex items-center justify-center text-dashboard-muted text-sm",children:"拠点住所から地図を読み込み中..."}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(o.h,{center:L,zoom:15,style:{height:"100%",width:"100%",minHeight:"400px",borderRadius:"0.5rem"},children:[(0,n.jsx)(u.I,{attribution:'\xa9 <a href="https://www.google.com/maps">Google</a>',url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",maxZoom:20}),(0,n.jsx)(b,{...e,flyTo:i})]}),N&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none rounded-lg bg-black/20",children:(0,n.jsx)("span",{className:"px-3 py-2 text-sm font-medium rounded-lg bg-dashboard-card text-dashboard-text shadow",children:"移動中..."})})]})})]})}},6763:function(e,t,l){async function n(e){let t=null==e?void 0:e.trim();if(!t)return null;let l=await fetch("/api/geocode?address=".concat(encodeURIComponent(t)));if(404===l.status||!l.ok)return null;let n=await l.json();return"number"!=typeof(null==n?void 0:n.lat)||"number"!=typeof(null==n?void 0:n.lng)?null:{lat:n.lat,lng:n.lng,displayName:n.displayName}}async function r(e,t){if("number"!=typeof e||"number"!=typeof t||Number.isNaN(e)||Number.isNaN(t))return null;let l=await fetch("/api/geocode?lat=".concat(encodeURIComponent(e),"&lng=").concat(encodeURIComponent(t)));if(404===l.status||!l.ok)return null;let n=await l.json();return"number"!=typeof(null==n?void 0:n.lat)||"number"!=typeof(null==n?void 0:n.lng)?null:{lat:n.lat,lng:n.lng,displayName:n.displayName}}l.d(t,{G:function(){return r},V:function(){return n}})}}]);