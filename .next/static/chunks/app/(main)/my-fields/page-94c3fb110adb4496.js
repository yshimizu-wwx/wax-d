(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[740],{8699:function(e,t,s){Promise.resolve().then(s.bind(s,8772))},8772:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return R}});var r=s(3827),a=s(4090),n=s(7907),l=s(4232),i=s(9299),o=s(94),d=s(7731),c=s(489),u=s(6288),m=s(8793),f=s(4656),x=s(47),h=s(6763),p=s(8228),g=s(5671),v=s(575),b=s(2782),j=s(2647),y=s(2815),N=s(2235),w=s(2169);let k=y.fC;y.xz;let z=y.h_;y.x8;let C=a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,r.jsx)(y.aV,{ref:t,className:(0,w.cn)("fixed inset-0 z-50 bg-black/50 transition-opacity data-[state=closed]:opacity-0 data-[state=open]:opacity-100",s),...a})});C.displayName=y.aV.displayName;let _=a.forwardRef((e,t)=>{let{className:s,children:a,showClose:n=!0,...l}=e;return(0,r.jsxs)(z,{children:[(0,r.jsx)(C,{}),(0,r.jsxs)(y.VY,{ref:t,className:(0,w.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-slate-200 bg-white p-6 shadow-xl transition-all duration-200 data-[state=closed]:opacity-0 data-[state=open]:opacity-100 data-[state=closed]:scale-95 data-[state=open]:scale-100 sm:rounded-2xl",s),...l,children:[a,n&&(0,r.jsxs)(y.x8,{className:"absolute right-4 top-4 rounded-lg p-1.5 text-slate-500 opacity-70 ring-offset-white transition-opacity hover:opacity-100 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-agrix-forest focus:ring-offset-2 disabled:pointer-events-none",children:[(0,r.jsx)(N.Z,{className:"h-5 w-5"}),(0,r.jsx)("span",{className:"sr-only",children:"閉じる"})]})]})]})});_.displayName=y.VY.displayName;let I=e=>{let{className:t,...s}=e;return(0,r.jsx)("div",{className:(0,w.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...s})};I.displayName="DialogHeader";let S=e=>{let{className:t,...s}=e;return(0,r.jsx)("div",{className:(0,w.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:gap-2",t),...s})};S.displayName="DialogFooter";let O=a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,r.jsx)(y.Dx,{ref:t,className:(0,w.cn)("text-lg font-bold leading-none tracking-tight text-slate-900",s),...a})});O.displayName=y.Dx.displayName,a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,r.jsx)(y.dk,{ref:t,className:(0,w.cn)("text-sm text-slate-500",s),...a})}).displayName=y.dk.displayName;let Z=(0,l.default)(()=>Promise.all([s.e(212),s.e(782),s.e(813)]).then(s.bind(s,6036)),{loadableGenerated:{webpack:()=>[6036]},ssr:!1,loading:()=>(0,r.jsx)("div",{className:"w-full min-h-[280px] bg-dashboard-card animate-pulse rounded-lg flex items-center justify-center text-dashboard-muted text-sm",children:"地図を読み込み中..."})});function R(){let e=(0,n.useRouter)(),[t,s]=(0,a.useState)(null),[l,y]=(0,a.useState)(!0),[N,w]=(0,a.useState)([]),[z,C]=(0,a.useState)(null),[R,A]=(0,a.useState)(!1),[E,J]=(0,a.useState)(""),[U,G]=(0,a.useState)(""),[V,F]=(0,a.useState)(""),[L,M]=(0,a.useState)(null),[P,Y]=(0,a.useState)(null),[D,X]=(0,a.useState)(!1),[B,Q]=(0,a.useState)(null);(0,a.useEffect)(()=>{(0,m.ts)().then(e=>{s(null!=e?e:null),y(!1)})},[]),(0,a.useEffect)(()=>{t&&"farmer"===t.role&&(0,f.cd)(t.id).then(w)},[t]),(0,a.useEffect)(()=>{!l&&t&&"farmer"!==t.role&&e.replace("/")},[t,l,e]);let q=()=>{C(null),J(""),G(""),F(""),M(null),Y(null),A(!0)},K=e=>{C(e.id),J(e.name||""),G(e.address||""),F(null!=e.area_size?String(e.area_size):""),A(!0)},H=()=>{A(!1),C(null)},T=(0,a.useCallback)(async(e,t,s)=>{if(s&&t>0){F(String(Math.round(10*t)/10));let[e,r]=(0,x.RX)(s);M(r),Y(e);let a=await (0,h.G)(r,e);(null==a?void 0:a.displayName)&&(G(a.displayName),J("".concat(a.displayName," 畑")))}else F(""),M(null),Y(null)},[]),W=async e=>{if(e.preventDefault(),t&&"farmer"===t.role){if(!z&&!E.trim()){u.toast.error("畑の名前を入力してください");return}X(!0);try{if(z){let e=await (0,f.L4)(z,{name:E||void 0,address:U||void 0,area_size:V?Number(V):void 0});e.success?(u.toast.success("畑を更新しました"),(0,f.cd)(t.id).then(w),H()):u.toast.error(e.error)}else{let e={farmer_id:t.id,name:E.trim()||void 0,address:U||void 0,area_size:V?Number(V):void 0,lat:null!=L?L:void 0,lng:null!=P?P:void 0},s=await (0,f.Gr)(e);s.success?(u.toast.success("畑を登録しました"),(0,f.cd)(t.id).then(w),H()):u.toast.error(s.error)}}finally{X(!1)}}},$=async e=>{let t=await (0,f.AK)(e);t.success?(u.toast.success("畑を削除しました"),w(t=>t.filter(t=>t.id!==e)),Q(null)):u.toast.error(t.error)};return l?(0,r.jsx)("main",{className:"min-h-full flex items-center justify-center",children:(0,r.jsx)(p.Z,{message:"読み込み中..."})}):t&&"farmer"===t.role?(0,r.jsx)("main",{className:"min-h-full",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8",children:[(0,r.jsxs)("h1",{className:"text-xl font-bold text-dashboard-text mb-2 flex items-center gap-2",children:[(0,r.jsx)(i.Z,{className:"w-6 h-6 text-agrix-forest"}),"マイ畑管理"]}),(0,r.jsx)("p",{className:"text-sm text-dashboard-muted mb-6",children:"登録した畑は、作業依頼や案件申込時に選択できます。"}),(0,r.jsx)("div",{className:"mb-6",children:(0,r.jsxs)(v.z,{onClick:q,className:"bg-agrix-forest hover:bg-agrix-forest-dark",children:[(0,r.jsx)(o.Z,{className:"w-4 h-4 mr-2"}),"畑を登録"]})}),(0,r.jsx)(g.Zb,{className:"overflow-hidden",children:0===N.length?(0,r.jsxs)(g.aY,{className:"p-10 flex flex-col items-center justify-center text-center",children:[(0,r.jsx)("div",{className:"rounded-full bg-agrix-forest/10 p-6 mb-4",children:(0,r.jsx)(i.Z,{className:"w-12 h-12 text-agrix-forest"})}),(0,r.jsx)("p",{className:"font-bold text-dashboard-text mb-1",children:"登録された畑はありません"}),(0,r.jsx)("p",{className:"text-sm text-dashboard-muted mb-4",children:"「畑を登録」から追加してください。"}),(0,r.jsxs)(v.z,{onClick:q,variant:"outline",children:[(0,r.jsx)(o.Z,{className:"w-4 h-4 mr-2"}),"畑を登録"]})]}):(0,r.jsx)("ul",{className:"divide-y divide-dashboard-border",children:N.map(e=>(0,r.jsxs)("li",{className:"p-4 flex flex-wrap items-center justify-between gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-bold text-dashboard-text",children:e.name||"（名称未設定）"}),(0,r.jsxs)("p",{className:"text-sm text-dashboard-muted",children:[e.address&&"".concat(e.address," \xb7 "),null!=e.area_size&&"".concat(e.area_size," 反")]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(v.z,{type:"button",variant:"outline",size:"sm",onClick:()=>K(e),children:(0,r.jsx)(d.Z,{className:"w-4 h-4"})}),(0,r.jsx)(v.z,{type:"button",variant:"outline",size:"sm",className:"text-red-600 border-red-200 hover:bg-red-50",onClick:()=>Q(e.id),children:(0,r.jsx)(c.Z,{className:"w-4 h-4"})})]})]},e.id))})}),(0,r.jsx)(k,{open:R,onOpenChange:e=>!e&&H(),children:(0,r.jsxs)(_,{className:z?"":"max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[(0,r.jsx)(I,{children:(0,r.jsx)(O,{children:z?"畑を編集":"畑を登録"})}),(0,r.jsxs)("form",{onSubmit:W,className:"space-y-4 flex flex-col min-h-0",children:[!z&&(0,r.jsxs)("div",{className:"space-y-1 shrink-0",children:[(0,r.jsx)(j._,{children:"地図で範囲を選択"}),(0,r.jsx)("p",{className:"text-xs text-dashboard-muted",children:"地図上でポリゴン（多角形）を描くと面積が自動計算されます。"}),(0,r.jsx)("div",{className:"w-full min-h-[280px] rounded-lg overflow-hidden border border-dashboard-border",children:(0,r.jsx)(Z,{onPolygonComplete:T,initialCenter:t&&null!=t.lat&&null!=t.lng?[t.lat,t.lng]:void 0,initialAddress:t&&(null==t.lat||null==t.lng)&&t.address?t.address:void 0,showAddressSearch:!0})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(j._,{htmlFor:"fieldName",children:"畑の名前"}),(0,r.jsx)(b.I,{id:"fieldName",value:E,onChange:e=>J(e.target.value),placeholder:"例: 北側水田",className:"mt-1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(j._,{htmlFor:"fieldAddress",children:"住所・場所"}),(0,r.jsx)(b.I,{id:"fieldAddress",value:U,onChange:e=>G(e.target.value),placeholder:"例: 〇〇県〇〇市...",className:"mt-1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(j._,{htmlFor:"fieldArea",children:"面積（反）"}),(0,r.jsx)(b.I,{id:"fieldArea",type:"number",min:"0",step:"0.1",value:V,onChange:e=>F(e.target.value),placeholder:z?"例: 5.5":"地図で描画すると自動入力",className:"mt-1"})]}),(0,r.jsxs)(S,{className:"shrink-0",children:[(0,r.jsx)(v.z,{type:"button",variant:"outline",onClick:H,children:"キャンセル"}),(0,r.jsx)(v.z,{type:"submit",disabled:D,className:"bg-agrix-forest hover:bg-agrix-forest-dark",children:D?"保存中...":z?"更新":"登録"})]})]})]})}),(0,r.jsx)(k,{open:!!B,onOpenChange:e=>!e&&Q(null),children:(0,r.jsxs)(_,{children:[(0,r.jsx)(I,{children:(0,r.jsx)(O,{children:"畑を削除しますか？"})}),(0,r.jsx)("p",{className:"text-sm text-dashboard-muted",children:"この操作は取り消せません。"}),(0,r.jsxs)(S,{children:[(0,r.jsx)(v.z,{variant:"outline",onClick:()=>Q(null),children:"キャンセル"}),(0,r.jsx)(v.z,{className:"bg-red-600 hover:bg-red-700",onClick:()=>B&&$(B),children:"削除"})]})]})})]})}):(0,r.jsx)("main",{className:"min-h-full flex items-center justify-center",children:(0,r.jsx)(p.Z,{message:"リダイレクト中..."})})}},8228:function(e,t,s){"use strict";s.d(t,{Z:function(){return l}});var r=s(3827),a=s(8994),n=s(2169);function l(e){let{message:t="読み込み中...",className:s}=e;return(0,r.jsxs)("div",{className:(0,n.cn)("flex min-h-[40vh] flex-col items-center justify-center gap-4",s),children:[(0,r.jsx)(a.Z,{className:"h-12 w-12 text-agrix-forest animate-spin","aria-hidden":!0}),(0,r.jsx)("p",{className:"text-sm font-medium text-slate-600",children:t})]})}},575:function(e,t,s){"use strict";s.d(t,{z:function(){return o}});var r=s(3827),a=s(4090),n=s(9769),l=s(2169);let i=(0,n.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-bold tracking-tight transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:pointer-events-none disabled:opacity-50 [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm",accent:"bg-accent text-accent-foreground hover:bg-accent/80 shadow-sm",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-primary bg-transparent text-primary hover:bg-primary/10",secondary:"bg-muted text-muted-foreground hover:bg-muted/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-11 px-5 py-2",sm:"h-9 rounded-md px-3 text-xs",lg:"h-12 rounded-lg px-8 text-base",icon:"h-10 w-10","icon-sm":"h-8 w-8","icon-lg":"h-12 w-12"}},defaultVariants:{variant:"default",size:"default"}}),o=a.forwardRef((e,t)=>{let{className:s,variant:a,size:n,...o}=e;return(0,r.jsx)("button",{className:(0,l.cn)(i({variant:a,size:n,className:s})),ref:t,...o})});o.displayName="Button"},2782:function(e,t,s){"use strict";s.d(t,{I:function(){return l}});var r=s(3827),a=s(4090),n=s(2169);let l=a.forwardRef((e,t)=>{let{className:s,type:a,...l}=e;return(0,r.jsx)("input",{type:a,className:(0,n.cn)("flex h-11 w-full rounded-lg border border-border bg-card px-4 py-2 text-sm font-medium text-foreground ring-offset-background transition-colors","placeholder:text-muted-foreground","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:border-primary","disabled:cursor-not-allowed disabled:opacity-50",s),ref:t,...l})});l.displayName="Input"},2647:function(e,t,s){"use strict";s.d(t,{_:function(){return l}});var r=s(3827),a=s(4090),n=s(2169);let l=a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,r.jsx)("label",{ref:t,className:(0,n.cn)("block text-sm font-bold text-foreground leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",s),...a})});l.displayName="Label"},8793:function(e,t,s){"use strict";s.d(t,{Lj:function(){return l},gQ:function(){return i},ts:function(){return a},w7:function(){return n}});var r=s(4958);async function a(){try{var e,t,s,a,n,l,i,o,d,c;let{data:{session:u}}=await r.O.auth.getSession();if(!(null==u?void 0:null===(e=u.user)||void 0===e?void 0:e.email))return null;let{data:m,error:f}=await r.O.from("users").select("*").eq("email",u.user.email).single();if(f||!m)return null;return{id:m.id,email:null!==(t=m.email)&&void 0!==t?t:"",role:m.role,name:null!==(s=m.name)&&void 0!==s?s:"",phone:null!==(a=m.phone)&&void 0!==a?a:"",status:null!==(n=m.status)&&void 0!==n?n:"",address:null!==(l=m.address)&&void 0!==l?l:void 0,lat:null!==(i=m.lat)&&void 0!==i?i:void 0,lng:null!==(o=m.lng)&&void 0!==o?o:void 0,associated_provider_id:null!==(d=m.associated_provider_id)&&void 0!==d?d:void 0,invitation_code:null!==(c=m.invitation_code)&&void 0!==c?c:void 0}}catch(e){return console.error("Error getting current user:",e),null}}async function n(){await r.O.auth.signOut(),window.location.href="/login"}async function l(e){try{var t;let{data:{session:s}}=await r.O.auth.getSession();if(!(null==s?void 0:null===(t=s.user)||void 0===t?void 0:t.email))return{success:!1,error:"ログインしていません"};let{error:a}=await r.O.from("users").update({...void 0!==e.name&&{name:e.name},...void 0!==e.phone&&{phone:e.phone},...void 0!==e.address&&{address:e.address}}).eq("email",s.user.email);if(a)return{success:!1,error:a.message};return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e){try{let{error:t}=await r.O.auth.updateUser({password:e});if(t)return{success:!1,error:t.message};return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}},6763:function(e,t,s){"use strict";async function r(e){let t=null==e?void 0:e.trim();if(!t)return null;let s=await fetch("/api/geocode?address=".concat(encodeURIComponent(t)));if(404===s.status||!s.ok)return null;let r=await s.json();return"number"!=typeof(null==r?void 0:r.lat)||"number"!=typeof(null==r?void 0:r.lng)?null:{lat:r.lat,lng:r.lng,displayName:r.displayName}}async function a(e,t){if("number"!=typeof e||"number"!=typeof t||Number.isNaN(e)||Number.isNaN(t))return null;let s=await fetch("/api/geocode?lat=".concat(encodeURIComponent(e),"&lng=").concat(encodeURIComponent(t)));if(404===s.status||!s.ok)return null;let r=await s.json();return"number"!=typeof(null==r?void 0:r.lat)||"number"!=typeof(null==r?void 0:r.lng)?null:{lat:r.lat,lng:r.lng,displayName:r.displayName}}s.d(t,{G:function(){return a},V:function(){return r}})},4958:function(e,t,s){"use strict";s.d(t,{O:function(){return r}});let r=(0,s(342).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dmllb3J3bnl4eGZ5Z2Joem55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjY1OTUsImV4cCI6MjA4NjQwMjU5NX0.-alPp1Cr1J2yoKcdaln4LMbOPjaGCb4wRjURGhibLPk")},2169:function(e,t,s){"use strict";s.d(t,{cn:function(){return n}});var r=s(3167),a=s(1367);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,a.m6)((0,r.W)(t))}}},function(e){e.O(0,[866,128,150,288,11,320,281,971,69,744],function(){return e(e.s=8699)}),_N_E=e.O()}]);