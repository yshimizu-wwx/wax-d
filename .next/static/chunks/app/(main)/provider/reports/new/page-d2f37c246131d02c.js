(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[183],{6721:function(e,r,t){Promise.resolve().then(t.bind(t,6051))},9108:function(e,r,t){"use strict";t.d(r,{Z:function(){return a}});/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,t(7461).Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]])},2944:function(e,r,t){"use strict";t.d(r,{Z:function(){return a}});/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,t(7461).Z)("FileCheck",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]])},2457:function(e,r,t){"use strict";t.d(r,{Z:function(){return a}});/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let a=(0,t(7461).Z)("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]])},8792:function(e,r,t){"use strict";t.d(r,{default:function(){return n.a}});var a=t(5250),n=t.n(a)},7907:function(e,r,t){"use strict";var a=t(5313);t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(r,{useSearchParams:function(){return a.useSearchParams}})},6051:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return h}});var a=t(3827),n=t(4090),s=t(7907),i=t(8792),l=t(9108),o=t(2944);/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let d=(0,t(7461).Z)("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);var u=t(2457),c=t(8793),f=t(4958),m=t(5671);function h(){let e=(0,s.useRouter)(),[r,t]=(0,n.useState)(null),[h,x]=(0,n.useState)([]),[b,p]=(0,n.useState)(!0),[g,v]=(0,n.useState)(!1),[j,w]=(0,n.useState)(null),[y,N]=(0,n.useState)(null),[_,k]=(0,n.useState)(""),[C,S]=(0,n.useState)(0),[O,Z]=(0,n.useState)(null),[I,P]=(0,n.useState)(null);(0,n.useEffect)(()=>{(async()=>{let r=await (0,c.ts)();if(!r||"provider"!==r.role){e.replace("/login");return}t(r);let{data:a}=await f.O.from("campaigns").select("id").eq("provider_id",r.id),n=(a||[]).map(e=>e.id);if(0===n.length){p(!1);return}let{data:s,error:i}=await f.O.from("bookings").select("id, campaign_id, farmer_id, area_10r, work_status").in("campaign_id",n).eq("work_status","pending").neq("status","canceled");if(i){w("申込一覧の取得に失敗しました"),p(!1);return}let l=s||[];if(l.length>0){let{data:e}=await f.O.from("campaigns").select("id, campaign_title, location, final_unit_price, base_price").in("id",[...new Set(l.map(e=>e.campaign_id))]),r=new Map((e||[]).map(e=>[e.id,e]));l.forEach(e=>{e.projects=r.get(e.campaign_id)})}x(l),l.length>0&&!_&&(k(l[0].id),S(Number(l[0].area_10r)||0)),p(!1)})()},[e]);let R=async e=>{if(e.preventDefault(),w(null),N(null),!_||C<=0){w("申込を選択し、実績面積を入力してください");return}v(!0);try{var r;let e,t;O&&(t=O.type||"image/jpeg",e=await new Promise((e,r)=>{let t=new FileReader;t.onload=()=>{let r=t.result,a=r.indexOf(",")>=0?r.split(",")[1]:r;e(a||"")},t.onerror=r,t.readAsDataURL(O)}));let a=await fetch("/api/provider/reports/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bookingId:_,actualArea10r:Number(C),imageBase64:e,mimeType:t,gps:null!=I?I:void 0})}),n=await a.json();if(!a.ok){w(n.message||"登録に失敗しました");return}N("実績を報告しました。確定金額: \xa5".concat((null!==(r=n.finalAmount)&&void 0!==r?r:0).toLocaleString())),x(e=>e.filter(e=>e.id!==_)),k(""),S(0),Z(null),P(null)}catch(e){w("送信に失敗しました")}finally{v(!1)}};return b?(0,a.jsx)("main",{className:"min-h-full flex items-center justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-agrix-forest"})}):(0,a.jsx)("main",{className:"min-h-full",children:(0,a.jsxs)("div",{className:"max-w-2xl mx-auto px-4 py-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,a.jsxs)(i.default,{href:"/admin/campaigns",className:"p-2 rounded-lg border border-dashboard-border hover:bg-dashboard-card flex items-center gap-2 text-dashboard-muted",children:[(0,a.jsx)(l.Z,{className:"w-5 h-5"}),"戻る"]}),(0,a.jsxs)("h1",{className:"text-2xl font-bold text-dashboard-text flex items-center gap-2",children:[(0,a.jsx)(o.Z,{className:"w-7 h-7 text-agrix-forest"}),"実績報告"]})]}),0===h.length?(0,a.jsx)(m.Zb,{children:(0,a.jsxs)(m.aY,{className:"p-8 text-center text-dashboard-muted",children:[(0,a.jsx)("p",{children:"報告可能な申込（作業未完了）がありません。"}),(0,a.jsx)(i.default,{href:"/admin/campaigns",className:"mt-4 inline-block text-agrix-forest font-medium hover:underline",children:"案件一覧へ"})]})}):(0,a.jsx)(m.Zb,{className:"overflow-hidden",children:(0,a.jsxs)("form",{onSubmit:R,children:[(0,a.jsxs)(m.aY,{className:"p-6 space-y-6",children:[j&&(0,a.jsx)("div",{className:"p-4 bg-destructive/10 border border-destructive/30 rounded-xl text-destructive text-sm font-medium",children:j}),y&&(0,a.jsx)("div",{className:"p-4 bg-agrix-forest/10 border border-agrix-forest/30 rounded-xl text-agrix-forest text-sm font-medium",children:y}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-bold text-dashboard-text mb-2",children:"対象申込"}),(0,a.jsxs)("select",{value:_,onChange:e=>{k(e.target.value);let r=h.find(r=>r.id===e.target.value);r&&S(Number(r.area_10r)||0)},className:"w-full p-3 bg-dashboard-bg border border-dashboard-border rounded-xl focus:ring-2 focus:ring-agrix-forest",required:!0,children:[(0,a.jsx)("option",{value:"",children:"選択してください"}),h.map(e=>{var r,t;return(0,a.jsxs)("option",{value:e.id,children:[null!==(t=null===(r=e.projects)||void 0===r?void 0:r.location)&&void 0!==t?t:e.campaign_id," — 申込ID: ",e.id,"（",e.area_10r," 反）"]},e.id)})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-bold text-dashboard-text mb-2",children:"実績面積（反）"}),(0,a.jsx)("input",{type:"number",step:"0.01",min:"0",value:C||"",onChange:e=>S(Number(e.target.value)||0),className:"w-full p-3 bg-dashboard-bg border border-dashboard-border rounded-xl focus:ring-2 focus:ring-agrix-forest",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-bold text-dashboard-text mb-2 flex items-center gap-2",children:[(0,a.jsx)(d,{className:"w-4 h-4"}),"証跡写真（任意）"]}),(0,a.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var r,t;return Z(null!==(t=null===(r=e.target.files)||void 0===r?void 0:r[0])&&void 0!==t?t:null)},className:"w-full text-sm text-dashboard-muted file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-agrix-forest/10 file:text-agrix-forest"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-bold text-dashboard-text mb-2 flex items-center gap-2",children:[(0,a.jsx)(u.Z,{className:"w-4 h-4"}),"GPS（任意）"]}),(0,a.jsx)("button",{type:"button",onClick:()=>{if(!navigator.geolocation){w("お使いの環境ではGPSを利用できません");return}navigator.geolocation.getCurrentPosition(e=>P({lat:e.coords.latitude,lng:e.coords.longitude}),()=>w("位置情報の取得に失敗しました"))},className:"px-4 py-2 bg-dashboard-bg hover:bg-dashboard-border rounded-lg text-sm font-medium text-dashboard-text",children:"現在地を取得"}),I&&(0,a.jsxs)("p",{className:"mt-2 text-xs text-dashboard-muted",children:[I.lat.toFixed(6),", ",I.lng.toFixed(6)]})]})]}),(0,a.jsx)("div",{className:"px-6 py-4 bg-dashboard-bg border-t border-dashboard-border",children:(0,a.jsx)("button",{type:"submit",disabled:g,className:"w-full py-3 bg-agrix-forest text-white font-bold rounded-xl hover:bg-agrix-forest-light disabled:opacity-50 disabled:cursor-not-allowed",children:g?"送信中...":"実績を報告する"})})]})})]})})}},5671:function(e,r,t){"use strict";t.d(r,{Ol:function(){return l},SZ:function(){return d},Zb:function(){return i},aY:function(){return u},ll:function(){return o}});var a=t(3827),n=t(4090),s=t(2169);let i=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("rounded-xl border border-border bg-card text-card-foreground shadow-sm transition-all duration-200 hover:shadow-md",t),...n})});i.displayName="Card";let l=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",t),...n})});l.displayName="CardHeader";let o=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("h3",{ref:r,className:(0,s.cn)("text-lg font-bold leading-none tracking-tight text-card-foreground",t),...n})});o.displayName="CardTitle";let d=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("p",{ref:r,className:(0,s.cn)("text-sm text-muted-foreground",t),...n})});d.displayName="CardDescription";let u=n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("p-6 pt-0",t),...n})});u.displayName="CardContent",n.forwardRef((e,r)=>{let{className:t,...n}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex items-center p-6 pt-0",t),...n})}).displayName="CardFooter"},8793:function(e,r,t){"use strict";t.d(r,{Lj:function(){return i},gQ:function(){return l},ts:function(){return n},w7:function(){return s}});var a=t(4958);async function n(){try{var e,r,t,n,s,i,l,o,d,u;let{data:{session:c}}=await a.O.auth.getSession();if(!(null==c?void 0:null===(e=c.user)||void 0===e?void 0:e.email))return null;let{data:f,error:m}=await a.O.from("users").select("*").eq("email",c.user.email).single();if(m||!f)return null;return{id:f.id,email:null!==(r=f.email)&&void 0!==r?r:"",role:f.role,name:null!==(t=f.name)&&void 0!==t?t:"",phone:null!==(n=f.phone)&&void 0!==n?n:"",status:null!==(s=f.status)&&void 0!==s?s:"",address:null!==(i=f.address)&&void 0!==i?i:void 0,lat:null!==(l=f.lat)&&void 0!==l?l:void 0,lng:null!==(o=f.lng)&&void 0!==o?o:void 0,associated_provider_id:null!==(d=f.associated_provider_id)&&void 0!==d?d:void 0,invitation_code:null!==(u=f.invitation_code)&&void 0!==u?u:void 0}}catch(e){return console.error("Error getting current user:",e),null}}async function s(){await a.O.auth.signOut(),window.location.href="/login"}async function i(e){try{var r;let{data:{session:t}}=await a.O.auth.getSession();if(!(null==t?void 0:null===(r=t.user)||void 0===r?void 0:r.email))return{success:!1,error:"ログインしていません"};let{error:n}=await a.O.from("users").update({...void 0!==e.name&&{name:e.name},...void 0!==e.phone&&{phone:e.phone},...void 0!==e.address&&{address:e.address}}).eq("email",t.user.email);if(n)return{success:!1,error:n.message};return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e){try{let{error:r}=await a.O.auth.updateUser({password:e});if(r)return{success:!1,error:r.message};return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}},4958:function(e,r,t){"use strict";t.d(r,{O:function(){return a}});let a=(0,t(342).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dmllb3J3bnl4eGZ5Z2Joem55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjY1OTUsImV4cCI6MjA4NjQwMjU5NX0.-alPp1Cr1J2yoKcdaln4LMbOPjaGCb4wRjURGhibLPk")},2169:function(e,r,t){"use strict";t.d(r,{cn:function(){return s}});var a=t(3167),n=t(1367);function s(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,n.m6)((0,a.W)(r))}}},function(e){e.O(0,[128,150,250,971,69,744],function(){return e(e.s=6721)}),_N_E=e.O()}]);