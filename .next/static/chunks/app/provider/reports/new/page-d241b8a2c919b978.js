(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{9977:function(e,t,r){Promise.resolve().then(r.bind(r,9170))},7461:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});var n=r(4090),a={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),s=(e,t)=>{let r=(0,n.forwardRef)((r,s)=>{let{color:i="currentColor",size:o=24,strokeWidth:d=2,absoluteStrokeWidth:c,className:u="",children:m,...f}=r;return(0,n.createElement)("svg",{ref:s,...a,width:o,height:o,stroke:i,strokeWidth:c?24*Number(d)/Number(o):d,className:["lucide","lucide-".concat(l(e)),u].join(" "),...f},[...t.map(e=>{let[t,r]=e;return(0,n.createElement)(t,r)}),...Array.isArray(m)?m:[m]])});return r.displayName="".concat(e),r}},9108:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(7461).Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]])},2457:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let n=(0,r(7461).Z)("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]])},8792:function(e,t,r){"use strict";r.d(t,{default:function(){return a.a}});var n=r(5250),a=r.n(n)},7907:function(e,t,r){"use strict";var n=r(5313);r.o(n,"usePathname")&&r.d(t,{usePathname:function(){return n.usePathname}}),r.o(n,"useRouter")&&r.d(t,{useRouter:function(){return n.useRouter}})},9170:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return g}});var n=r(3827),a=r(4090),l=r(7907),s=r(8792),i=r(9108),o=r(7461);/**
 * @license lucide-react v0.300.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let d=(0,o.Z)("FileCheck",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]),c=(0,o.Z)("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);var u=r(2457),m=r(8793),f=r(4958);function g(){let e=(0,l.useRouter)(),[t,r]=(0,a.useState)(null),[o,g]=(0,a.useState)([]),[h,x]=(0,a.useState)(!0),[p,b]=(0,a.useState)(!1),[v,w]=(0,a.useState)(null),[j,y]=(0,a.useState)(null),[N,k]=(0,a.useState)(""),[_,S]=(0,a.useState)(0),[C,O]=(0,a.useState)(null),[P,Z]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{let t=await (0,m.ts)();if(!t||"provider"!==t.role){e.replace("/login");return}r(t);let{data:n}=await f.O.from("projects").select("id").eq("provider_id",t.id),a=(n||[]).map(e=>e.id);if(0===a.length){x(!1);return}let{data:l,error:s}=await f.O.from("bookings").select("id, campaign_id, farmer_id, area_10r, work_status").in("campaign_id",a).eq("work_status","pending").neq("status","canceled");if(s){w("申込一覧の取得に失敗しました"),x(!1);return}let i=l||[];if(i.length>0){let{data:e}=await f.O.from("projects").select("id, campaign_title, location, final_unit_price, base_price").in("id",[...new Set(i.map(e=>e.campaign_id))]),t=new Map((e||[]).map(e=>[e.id,e]));i.forEach(e=>{e.projects=t.get(e.campaign_id)})}g(i),i.length>0&&!N&&(k(i[0].id),S(Number(i[0].area_10r)||0)),x(!1)})()},[e]);let L=async e=>{if(e.preventDefault(),w(null),y(null),!N||_<=0){w("申込を選択し、実績面積を入力してください");return}b(!0);try{var t;let e,r;C&&(r=C.type||"image/jpeg",e=await new Promise((e,t)=>{let r=new FileReader;r.onload=()=>{let t=r.result,n=t.indexOf(",")>=0?t.split(",")[1]:t;e(n||"")},r.onerror=t,r.readAsDataURL(C)}));let n=await fetch("/api/provider/reports/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bookingId:N,actualArea10r:Number(_),imageBase64:e,mimeType:r,gps:null!=P?P:void 0})}),a=await n.json();if(!n.ok){w(a.message||"登録に失敗しました");return}y("実績を報告しました。確定金額: \xa5".concat((null!==(t=a.finalAmount)&&void 0!==t?t:0).toLocaleString())),g(e=>e.filter(e=>e.id!==N)),k(""),S(0),O(null),Z(null)}catch(e){w("送信に失敗しました")}finally{b(!1)}};return h?(0,n.jsx)("main",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"})}):(0,n.jsx)("main",{className:"min-h-screen bg-slate-50",children:(0,n.jsxs)("div",{className:"max-w-2xl mx-auto px-4 py-8",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,n.jsxs)(s.default,{href:"/admin/campaigns",className:"p-2 rounded-lg border border-slate-200 hover:bg-white flex items-center gap-2 text-slate-600",children:[(0,n.jsx)(i.Z,{className:"w-5 h-5"}),"戻る"]}),(0,n.jsxs)("h1",{className:"text-2xl font-bold text-slate-800 flex items-center gap-2",children:[(0,n.jsx)(d,{className:"w-7 h-7 text-green-600"}),"実績報告"]})]}),0===o.length?(0,n.jsxs)("div",{className:"bg-white rounded-2xl border border-slate-200 p-8 text-center text-slate-600",children:[(0,n.jsx)("p",{children:"報告可能な申込（作業未完了）がありません。"}),(0,n.jsx)(s.default,{href:"/admin/campaigns",className:"mt-4 inline-block text-green-600 font-medium hover:underline",children:"案件一覧へ"})]}):(0,n.jsxs)("form",{onSubmit:L,className:"bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden",children:[(0,n.jsxs)("div",{className:"p-6 space-y-6",children:[v&&(0,n.jsx)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm font-medium",children:v}),j&&(0,n.jsx)("div",{className:"p-4 bg-green-50 border border-green-200 rounded-xl text-green-700 text-sm font-medium",children:j}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-bold text-slate-700 mb-2",children:"対象申込"}),(0,n.jsxs)("select",{value:N,onChange:e=>{k(e.target.value);let t=o.find(t=>t.id===e.target.value);t&&S(Number(t.area_10r)||0)},className:"w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500",required:!0,children:[(0,n.jsx)("option",{value:"",children:"選択してください"}),o.map(e=>{var t,r;return(0,n.jsxs)("option",{value:e.id,children:[null!==(r=null===(t=e.projects)||void 0===t?void 0:t.location)&&void 0!==r?r:e.campaign_id," — 申込ID: ",e.id,"（",e.area_10r," 反）"]},e.id)})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-bold text-slate-700 mb-2",children:"実績面積（反）"}),(0,n.jsx)("input",{type:"number",step:"0.01",min:"0",value:_||"",onChange:e=>S(Number(e.target.value)||0),className:"w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500",required:!0})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{className:"block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2",children:[(0,n.jsx)(c,{className:"w-4 h-4"}),"証跡写真（任意）"]}),(0,n.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t,r;return O(null!==(r=null===(t=e.target.files)||void 0===t?void 0:t[0])&&void 0!==r?r:null)},className:"w-full text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-50 file:text-green-700"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{className:"block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2",children:[(0,n.jsx)(u.Z,{className:"w-4 h-4"}),"GPS（任意）"]}),(0,n.jsx)("button",{type:"button",onClick:()=>{if(!navigator.geolocation){w("お使いの環境ではGPSを利用できません");return}navigator.geolocation.getCurrentPosition(e=>Z({lat:e.coords.latitude,lng:e.coords.longitude}),()=>w("位置情報の取得に失敗しました"))},className:"px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium text-slate-700",children:"現在地を取得"}),P&&(0,n.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:[P.lat.toFixed(6),", ",P.lng.toFixed(6)]})]})]}),(0,n.jsx)("div",{className:"px-6 py-4 bg-slate-50 border-t border-slate-200",children:(0,n.jsx)("button",{type:"submit",disabled:p,className:"w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed",children:p?"送信中...":"実績を報告する"})})]})]})})}},8793:function(e,t,r){"use strict";r.d(t,{ts:function(){return a},w7:function(){return l}});var n=r(4958);async function a(){try{let{data:{session:e}}=await n.O.auth.getSession();if(!e)return null;let{data:t,error:r}=await n.O.from("users").select("*").eq("email",e.user.email).single();if(r||!t)return null;return t}catch(e){return console.error("Error getting current user:",e),null}}async function l(){await n.O.auth.signOut(),window.location.href="/login"}},4958:function(e,t,r){"use strict";r.d(t,{O:function(){return n}});let n=(0,r(6070).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","sb_publishable_saY21TLJVLBNk5lg53j5Pg_PW9RAlEr")}},function(e){e.O(0,[755,250,971,69,744],function(){return e(e.s=9977)}),_N_E=e.O()}]);