exports.id=213,exports.ids=[213],exports.modules={9855:(e,r,t)=>{Promise.resolve().then(t.t.bind(t,2583,23)),Promise.resolve().then(t.t.bind(t,6840,23)),Promise.resolve().then(t.t.bind(t,8771,23)),Promise.resolve().then(t.t.bind(t,3225,23)),Promise.resolve().then(t.t.bind(t,9295,23)),Promise.resolve().then(t.t.bind(t,3982,23))},8750:(e,r,t)=>{Promise.resolve().then(t.bind(t,4755)),Promise.resolve().then(t.bind(t,2041))},2041:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>m});var a=t(5344),n=t(3729),s=t(6506),i=t(8428),o=t(2273),c=t(1917),l=t(9895),d=t(8120),u=t(5750);function m(){var e;let r=(0,i.usePathname)(),[t,m]=(0,n.useState)(null),[g,_]=(0,n.useState)(!0);(0,n.useEffect)(()=>{(0,u.ts)().then(m).finally(()=>_(!1))},[]);let p=async()=>{await (0,u.w7)()},f="/login"===r;return a.jsx("header",{className:"bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center",children:[(0,a.jsxs)(s.default,{href:"/",className:"text-xl font-black text-slate-800 tracking-tight hover:text-green-600 transition-colors",children:[a.jsx("span",{className:"text-green-600",children:"\uD83C\uDF3E"})," Wayfinder AgriX"]}),a.jsx("nav",{className:"flex items-center gap-3",children:g?a.jsx("span",{className:"text-slate-400 text-sm",children:"..."}):t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(s.default,{href:"admin"===(e=t.role)||"provider"===e?"/admin":"/",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(o.Z,{className:"w-4 h-4"}),"マイページ"]}),("admin"===t.role||"provider"===t.role)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(s.default,{href:"/admin/masters",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(c.Z,{className:"w-4 h-4"}),"マスタ"]}),(0,a.jsxs)(s.default,{href:"/admin/users",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(l.Z,{className:"w-4 h-4"}),"ユーザー"]})]}),(0,a.jsxs)("button",{type:"button",onClick:p,className:"text-sm font-bold text-slate-700 hover:text-red-600 transition-colors px-3 py-2 rounded-lg hover:bg-red-50 border border-slate-200 hover:border-red-200 flex items-center gap-1",children:[a.jsx(d.Z,{className:"w-4 h-4"}),"ログアウト"]})]}):a.jsx(s.default,{href:f?"/":"/login",className:"text-sm font-bold text-white bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition-colors",children:f?"トップへ":"ログイン"})})]})})}},8732:(e,r,t)=>{"use strict";t.d(r,{dm:()=>d,TB:()=>c,mK:()=>l,g8:()=>i,x1:()=>o});var a=t(8704);function n(e){let r=e.coordinates[0].map(([e,r])=>`${e} ${r}`).join(", ");return`POLYGON((${r}))`}t(1968);var s=t(4133);async function i(){let{data:e,error:r}=await a.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1}).limit(1).single();return r?("PGRST116"===r.code?console.log("No active project found"):console.error("Error fetching active project:",r),null):e}async function o(e){let{data:r,error:t}=await a.O.from("bookings").select("area_10r").eq("campaign_id",e).neq("status","canceled");return t?(console.error("Error fetching campaign total area:",t),0):r?.reduce((e,r)=>e+(r.area_10r||0),0)||0}async function c(e){try{let{data:r,error:t}=await a.O.from("projects").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",e.campaign_id).single();if(t||!r)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(r))return{success:!1,error:"この案件は募集終了しています"};let i=await o(e.campaign_id),c=Number(r.max_target_area_10r)>0?Number(r.max_target_area_10r):Number(r.target_area_10r)||1,l=(0,s.ae)(e.area_10r,i,c);if(!l.isValid)return{success:!1,error:l.errorMessage??"申込面積が上限を超えています"};let d=n(e.field_polygon),u=`BK_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,m={id:u,campaign_id:e.campaign_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:d,area_10r:e.area_10r,locked_price:e.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=e.farmer_id&&""!==e.farmer_id&&(m.farmer_id=e.farmer_id);let{data:g,error:_}=await a.O.from("bookings").insert(m).select("id").single();if(_)return console.error("Error creating booking:",_),{success:!1,error:_.message};return{success:!0,bookingId:g?.id||u}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function l(e,r){try{let t=n(e.targetAreaPolygon),s=`C_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{data:i,error:o}=await a.O.from("projects").insert({id:s,provider_id:r||null,location:e.location,start_date:e.startDate,end_date:e.endDate,target_crop_id:e.cropId||null,task_category_id:e.categoryId||null,task_detail_id:e.detailId||null,pesticide_name:e.pesticide||null,dilution_rate:e.dilutionRate?parseFloat(e.dilutionRate):null,amount_per_10r:e.amountPer10r?parseFloat(e.amountPer10r):null,base_price:e.basePrice,min_price:e.minPrice,min_target_area_10r:e.minTargetArea10r||null,target_area_10r:e.targetArea10r,max_target_area_10r:e.maxTargetArea10r??e.targetArea10r??null,execution_price:e.executionPrice??null,confirmation_deadline_days:e.confirmationDeadlineDays||null,target_area_polygon:t,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(o)return console.error("Error creating campaign:",o),{success:!1,error:o.message};return{success:!0,campaignId:i?.id||s}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function d(e){let{data:r,error:t}=await a.O.from("projects").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",e).single();if(t||!r)return{success:!1,error:"案件が見つかりません"};let n=await o(e),i={base_price:Number(r.base_price)||0,min_price:Number(r.min_price)||0,target_area_10r:Number(r.target_area_10r)||0,min_target_area_10r:r.min_target_area_10r,max_target_area_10r:r.max_target_area_10r,execution_price:r.execution_price},c=(0,s.Bx)(i,n).currentPrice??(i.min_price||i.base_price)??0,{error:l}=await a.O.from("projects").update({status:"closed",is_closed:!0,final_unit_price:c}).eq("id",e);if(l)return{success:!1,error:l.message};let{error:d}=await a.O.from("bookings").update({locked_price:c}).eq("campaign_id",e).neq("status","canceled");return d?{success:!1,error:d.message}:{success:!0}}},5750:(e,r,t)=>{"use strict";t.d(r,{ts:()=>n,w7:()=>s});var a=t(8704);async function n(){try{let{data:{session:e}}=await a.O.auth.getSession();if(!e)return null;let{data:r,error:t}=await a.O.from("users").select("*").eq("email",e.user.email).single();if(t||!r)return null;return r}catch(e){return console.error("Error getting current user:",e),null}}async function s(){await a.O.auth.signOut(),window.location.href="/login"}},4133:(e,r,t)=>{"use strict";function a(e,r){let{base_price:t,min_price:a,target_area_10r:n,min_target_area_10r:s=0,max_target_area_10r:i,execution_price:o}=e;if(t<a)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return s>0&&i&&i>0&&o?function(e,r){let{base_price:t,min_price:a,min_target_area_10r:n,max_target_area_10r:s,execution_price:i}=e;if(r<n){let e=n-r;return{currentPrice:null,progress:r/n,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=s)return{currentPrice:Math.round(a),progress:1,isUnformed:!1,priceReduction:t-a,remainingArea:0,nextMilestoneArea:0};let o=(r-n)/(s-n),c=i+(a-i)*o,l=s-r;return{currentPrice:Math.round(c),progress:o,isUnformed:!1,priceReduction:t-c,remainingArea:l,nextMilestoneArea:l}}(e,r):function(e,r){let{base_price:t,min_price:a,target_area_10r:n}=e,s=Math.min(r/n,1),i=t-(t-a)*s,o=Math.max(0,n-r);return{currentPrice:Math.round(i),progress:s,isUnformed:!1,priceReduction:t-i,remainingArea:o,nextMilestoneArea:o>0?o:void 0}}(e,r)}function n(e,r,t){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:t-r,maxArea:t};let a=t-r;return e>a?{isValid:!1,errorMessage:`申し込み面積が上限を超えています。残り ${a.toFixed(1)} 反まで予約可能です。`,currentTotalArea:r,remainingArea:a,maxArea:t}:{isValid:!0,currentTotalArea:r,remainingArea:a,maxArea:t}}t.d(r,{Bx:()=>a,ae:()=>n})},8704:(e,r,t)=>{"use strict";t.d(r,{O:()=>a});let a=(0,t(3974).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","sb_publishable_saY21TLJVLBNk5lg53j5Pg_PW9RAlEr")},7858:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>_,metadata:()=>g});var a=t(5036),n=t(3740),s=t.n(n),i=t(4070),o=t.n(i);t(5023);let c=(0,t(6843).createProxy)(String.raw`C:\Users\yusuk\Documents\wwx\Wayfinder AgriX\v3-app\src\components\Header.tsx`),{__esModule:l,$$typeof:d}=c,u=c.default;var m=t(7171);let g={title:"Wayfinder AgriX - ドローンあいのり予約",description:"農家と業者をつなぐ農作業予約プラットフォーム"};function _({children:e}){return a.jsx("html",{lang:"ja",children:(0,a.jsxs)("body",{className:`${s().variable} ${o().variable} antialiased`,children:[a.jsx(u,{}),e,a.jsx(m.x7,{position:"top-center",richColors:!0,closeButton:!0})]})})}},3881:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>n});var a=t(337);let n=e=>[{type:"image/x-icon",sizes:"16x16",url:(0,a.fillMetadataSegment)(".",e.params,"favicon.ico")+""}]},5023:()=>{}};