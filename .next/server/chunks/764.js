"use strict";exports.id=764,exports.ids=[764],exports.modules={3673:(e,r,a)=>{a.d(r,{Ol:()=>o,SZ:()=>d,Zb:()=>s,aY:()=>l,ll:()=>c});var t=a(5344),n=a(3729),i=a(1453);let s=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,i.cn)("rounded-xl border border-border bg-card text-card-foreground shadow-sm transition-all duration-200 hover:shadow-md",e),...r}));s.displayName="Card";let o=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",e),...r}));o.displayName="CardHeader";let c=n.forwardRef(({className:e,...r},a)=>t.jsx("h3",{ref:a,className:(0,i.cn)("text-lg font-bold leading-none tracking-tight text-card-foreground",e),...r}));c.displayName="CardTitle";let d=n.forwardRef(({className:e,...r},a)=>t.jsx("p",{ref:a,className:(0,i.cn)("text-sm text-muted-foreground",e),...r}));d.displayName="CardDescription";let l=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,i.cn)("p-6 pt-0",e),...r}));l.displayName="CardContent",n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,i.cn)("flex items-center p-6 pt-0",e),...r})).displayName="CardFooter"},7083:(e,r,a)=>{a.d(r,{dm:()=>N,TB:()=>b,mK:()=>h,Gr:()=>A,xC:()=>v,AK:()=>M,ss:()=>y,x1:()=>k,cd:()=>q,v2:()=>w,xW:()=>O,L4:()=>E});var t=a(8704),n=a(5479),i=a(4133);async function s(e){let{data:r,error:a}=await e.from("campaigns").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1});return a?(console.error("Error fetching open campaigns:",a),[]):r??[]}async function o(e,r){let{data:a,error:t}=await e.from("bookings").select("area_10r").eq("campaign_id",r).neq("status","canceled");return t?(console.error("Error fetching campaign total area:",t),0):(a??[]).reduce((e,r)=>e+(Number(r?.area_10r)||0),0)}async function c(e,r,a){try{let t=(0,n.NO)(r.targetAreaPolygon),i=`C_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,{data:s,error:o}=await e.from("campaigns").insert({id:i,provider_id:a??null,location:r.location,start_date:r.startDate,end_date:r.endDate,target_crop_id:r.cropId||null,task_category_id:r.categoryId||null,task_detail_id:r.detailId||null,pesticide_name:r.pesticide||null,dilution_rate:r.dilutionRate?parseFloat(r.dilutionRate):null,amount_per_10r:r.amountPer10r?parseFloat(r.amountPer10r):null,base_price:r.basePrice,min_price:r.minPrice,min_target_area_10r:r.minTargetArea10r||null,target_area_10r:r.targetArea10r,max_target_area_10r:r.maxTargetArea10r??r.targetArea10r??null,execution_price:r.executionPrice??null,confirmation_deadline_days:r.confirmationDeadlineDays||null,target_area_polygon:t,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(o)return console.error("Error creating campaign:",o),{success:!1,error:o.message};return{success:!0,campaignId:s?.id??i}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function d(e,r){let{data:a,error:t}=await e.from("campaigns").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",r).single();if(t||!a)return{success:!1,error:"案件が見つかりません"};let n=await o(e,r),s={base_price:Number(a.base_price)||0,min_price:Number(a.min_price)||0,target_area_10r:Number(a.target_area_10r)||0,min_target_area_10r:a.min_target_area_10r??void 0,max_target_area_10r:a.max_target_area_10r??void 0,execution_price:a.execution_price??void 0},c=(0,i.Bx)(s,n).currentPrice??s.min_price??s.base_price??0,{error:d}=await e.from("campaigns").update({status:"closed",is_closed:!0,final_unit_price:c}).eq("id",r);if(d)return{success:!1,error:d.message};let{error:l}=await e.from("bookings").update({locked_price:c}).eq("campaign_id",r).neq("status","canceled");return l?{success:!1,error:l.message}:{success:!0}}async function l(e,r){let{data:a,error:t}=await e.from("bookings").select("id, campaign_id, area_10r, status, work_status, locked_price, created_at").eq("farmer_id",r).order("created_at",{ascending:!1});if(t)return console.error("Error fetching farmer bookings:",t),[];let n=a??[];if(0===n.length)return[];let i=[...new Set(n.map(e=>e.campaign_id))],{data:s}=await e.from("campaigns").select("id, location, campaign_title, start_date, end_date, status, is_closed").in("id",i),o=new Map;return(s??[]).forEach(e=>{o.set(e.id,{id:e.id,location:e.location??"",campaign_title:e.campaign_title,start_date:e.start_date,end_date:e.end_date,status:e.status,is_closed:e.is_closed})}),n.map(e=>({id:e.id,campaign_id:e.campaign_id,area_10r:Number(e.area_10r)||0,status:e.status??"",work_status:e.work_status,locked_price:null!=e.locked_price?Number(e.locked_price):void 0,created_at:e.created_at,project:o.get(e.campaign_id)}))}async function _(e,r){try{let{data:a,error:t}=await e.from("campaigns").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",r.campaign_id).single();if(t||!a)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(a))return{success:!1,error:"この案件は募集終了しています"};let s=await o(e,r.campaign_id),c=Number(a.max_target_area_10r)>0?Number(a.max_target_area_10r):Number(a.target_area_10r)||1,d=(0,i.ae)(r.area_10r,s,c);if(!d.isValid)return{success:!1,error:d.errorMessage??"申込面積が上限を超えています"};let l=(0,n.NO)(r.field_polygon),_=`BK_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,u={id:_,campaign_id:r.campaign_id,farmer_name:r.farmer_name,phone:r.phone,email:r.email,desired_start_date:r.desired_start_date,desired_end_date:r.desired_end_date,field_polygon:l,area_10r:r.area_10r,locked_price:r.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=r.farmer_id&&""!==r.farmer_id&&(u.farmer_id=r.farmer_id);let{data:m,error:f}=await e.from("bookings").insert(u).select("id").single();if(f)return console.error("Error creating booking:",f),{success:!1,error:f.message};return{success:!0,bookingId:m?.id??_}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function u(e,r){let{data:a,error:t}=await e.from("fields").select("*").eq("farmer_id",r).order("created_at",{ascending:!1});return t?(console.error("Error fetching fields:",t),[]):a??[]}async function m(e,r){try{let a=`F_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,{data:t,error:n}=await e.from("fields").insert({id:a,farmer_id:r.farmer_id,name:r.name??null,address:r.address??null,area_size:r.area_size??null,lat:r.lat??null,lng:r.lng??null}).select("id").single();if(n)return console.error("Error creating field:",n),{success:!1,error:n.message};return{success:!0,fieldId:t?.id??a}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function f(e,r,a){let t={};void 0!==a.name&&(t.name=a.name),void 0!==a.address&&(t.address=a.address),void 0!==a.area_size&&(t.area_size=a.area_size),void 0!==a.lat&&(t.lat=a.lat),void 0!==a.lng&&(t.lng=a.lng);let{error:n}=await e.from("fields").update(t).eq("id",r);return n?(console.error("Error updating field:",n),{success:!1,error:n.message}):{success:!0}}async function g(e,r){let{error:a}=await e.from("fields").delete().eq("id",r);return a?(console.error("Error deleting field:",a),{success:!1,error:a.message}):{success:!0}}async function p(e,r){try{let a=`WR_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,{data:t,error:n}=await e.from("work_requests").insert({id:a,farmer_id:r.farmer_id,location:r.location??null,crop_name_free_text:r.crop_name_free_text??null,task_category_free_text:r.task_category_free_text??null,task_detail_free_text:r.task_detail_free_text??null,desired_start_date:r.desired_start_date??null,desired_end_date:r.desired_end_date??null,estimated_area_10r:r.estimated_area_10r??null,desired_price:r.desired_price??null,notes:r.notes??null,status:"pending"}).select("id").single();if(n)return console.error("Error creating work request:",n),{success:!1,error:n.message};return{success:!0,requestId:t?.id??a}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function x(e,r){let{data:a,error:t}=await e.from("work_requests").select("*").eq("farmer_id",r).order("created_at",{ascending:!1});return t?(console.error("Error fetching work requests:",t),[]):a??[]}async function w(){return s(t.O)}async function y(e){return l(t.O,e)}async function k(e){return o(t.O,e)}async function b(e){return _(t.O,{campaign_id:e.campaign_id,farmer_id:e.farmer_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:e.field_polygon,area_10r:e.area_10r,locked_price:e.locked_price})}async function h(e,r){return c(t.O,e,r)}async function N(e){return d(t.O,e)}async function v(e){return p(t.O,e)}async function O(e){return x(t.O,e)}async function q(e){return u(t.O,e)}async function A(e){return m(t.O,e)}async function E(e,r){return f(t.O,e,r)}async function M(e){return g(t.O,e)}},4133:(e,r,a)=>{function t(e,r){let{base_price:a,min_price:t,target_area_10r:n,min_target_area_10r:i=0,max_target_area_10r:s,execution_price:o}=e;if(a<t)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return i>0&&s&&s>0&&o?function(e,r){let{base_price:a,min_price:t,min_target_area_10r:n,max_target_area_10r:i,execution_price:s}=e;if(r<n){let e=n-r;return{currentPrice:null,progress:r/n,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=i)return{currentPrice:Math.round(t),progress:1,isUnformed:!1,priceReduction:a-t,remainingArea:0,nextMilestoneArea:0};let o=(r-n)/(i-n),c=s+(t-s)*o,d=i-r;return{currentPrice:Math.round(c),progress:o,isUnformed:!1,priceReduction:a-c,remainingArea:d,nextMilestoneArea:d}}(e,r):function(e,r){let{base_price:a,min_price:t,target_area_10r:n}=e,i=Math.min(r/n,1),s=a-(a-t)*i,o=Math.max(0,n-r);return{currentPrice:Math.round(s),progress:i,isUnformed:!1,priceReduction:a-s,remainingArea:o,nextMilestoneArea:o>0?o:void 0}}(e,r)}function n(e,r,a){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:a-r,maxArea:a};let t=a-r;return e>t?{isValid:!1,errorMessage:`申し込み面積が上限を超えています。残り ${t.toFixed(1)} 反まで予約可能です。`,currentTotalArea:r,remainingArea:t,maxArea:a}:{isValid:!0,currentTotalArea:r,remainingArea:t,maxArea:a}}a.d(r,{Bx:()=>t,ae:()=>n})},5479:(e,r,a)=>{a.d(r,{NO:()=>n,RX:()=>i});var t=a(1968);function n(e){let r=e.coordinates[0].map(([e,r])=>`${e} ${r}`).join(", ");return`POLYGON((${r}))`}function i(e){return t.beQ(e).geometry.coordinates}}};