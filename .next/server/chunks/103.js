exports.id=103,exports.ids=[103],exports.modules={9855:(e,r,t)=>{Promise.resolve().then(t.t.bind(t,2583,23)),Promise.resolve().then(t.t.bind(t,6840,23)),Promise.resolve().then(t.t.bind(t,8771,23)),Promise.resolve().then(t.t.bind(t,3225,23)),Promise.resolve().then(t.t.bind(t,9295,23)),Promise.resolve().then(t.t.bind(t,3982,23))},7125:(e,r,t)=>{Promise.resolve().then(t.bind(t,4755)),Promise.resolve().then(t.bind(t,2041))},2041:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>g});var a=t(5344),s=t(3729),n=t(6506),i=t(8428),o=t(2273),c=t(7121),l=t(4243),d=t(1917),u=t(9895),m=t(8120),_=t(5750);function g(){var e;let r=(0,i.usePathname)(),[t,g]=(0,s.useState)(null),[p,f]=(0,s.useState)(!0);(0,s.useEffect)(()=>{(0,_.ts)().then(g).finally(()=>f(!1))},[]);let x=async()=>{await (0,_.w7)()},h="/login"===r;return a.jsx("header",{className:"bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center",children:[(0,a.jsxs)(n.default,{href:"/",className:"text-xl font-black text-slate-800 tracking-tight hover:text-green-600 transition-colors",children:[a.jsx("span",{className:"text-green-600",children:"\uD83C\uDF3E"})," Wayfinder AgriX"]}),a.jsx("nav",{className:"flex items-center gap-3",children:p?a.jsx("span",{className:"text-slate-400 text-sm",children:"..."}):t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.default,{href:"admin"===(e=t.role)||"provider"===e?"/admin":"/",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(o.Z,{className:"w-4 h-4"}),"マイページ"]}),"farmer"===t.role&&(0,a.jsxs)(n.default,{href:"/#applications",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(c.Z,{className:"w-4 h-4"}),"申込履歴"]}),"provider"===t.role&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.default,{href:"/provider/reports/new",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(c.Z,{className:"w-4 h-4"}),"実績報告"]}),(0,a.jsxs)(n.default,{href:"/provider/billings",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(l.Z,{className:"w-4 h-4"}),"請求"]})]}),("admin"===t.role||"provider"===t.role)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.default,{href:"/admin/masters",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(d.Z,{className:"w-4 h-4"}),"マスタ"]}),(0,a.jsxs)(n.default,{href:"/admin/users",className:"text-sm font-bold text-slate-700 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-1",children:[a.jsx(u.Z,{className:"w-4 h-4"}),"ユーザー"]})]}),(0,a.jsxs)("button",{type:"button",onClick:x,className:"text-sm font-bold text-slate-700 hover:text-red-600 transition-colors px-3 py-2 rounded-lg hover:bg-red-50 border border-slate-200 hover:border-red-200 flex items-center gap-1",children:[a.jsx(m.Z,{className:"w-4 h-4"}),"ログアウト"]})]}):a.jsx(n.default,{href:h?"/":"/login",className:"text-sm font-bold text-white bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition-colors",children:h?"トップへ":"ログイン"})})]})})}},8732:(e,r,t)=>{"use strict";t.d(r,{dm:()=>m,TB:()=>d,mK:()=>u,g8:()=>i,ss:()=>c,x1:()=>l,v2:()=>o});var a=t(8704);function s(e){let r=e.coordinates[0].map(([e,r])=>`${e} ${r}`).join(", ");return`POLYGON((${r}))`}t(1968);var n=t(4133);async function i(){let{data:e,error:r}=await a.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1}).limit(1).single();return r?("PGRST116"===r.code?console.log("No active project found"):console.error("Error fetching active project:",r),null):e}async function o(){let{data:e,error:r}=await a.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1});return r?(console.error("Error fetching open campaigns:",r),[]):e||[]}async function c(e){let{data:r,error:t}=await a.O.from("bookings").select("id, campaign_id, area_10r, status, work_status, locked_price, created_at").eq("farmer_id",e).order("created_at",{ascending:!1});if(t)return console.error("Error fetching farmer bookings:",t),[];let s=r||[];if(0===s.length)return[];let n=[...new Set(s.map(e=>e.campaign_id))],{data:i}=await a.O.from("projects").select("id, location, campaign_title, start_date, end_date, status, is_closed").in("id",n),o=new Map;return(i||[]).forEach(e=>{o.set(e.id,{id:e.id,location:e.location||"",campaign_title:e.campaign_title,start_date:e.start_date,end_date:e.end_date,status:e.status,is_closed:e.is_closed})}),s.map(e=>({id:e.id,campaign_id:e.campaign_id,area_10r:Number(e.area_10r)||0,status:e.status||"",work_status:e.work_status,locked_price:null!=e.locked_price?Number(e.locked_price):void 0,created_at:e.created_at,project:o.get(e.campaign_id)}))}async function l(e){let{data:r,error:t}=await a.O.from("bookings").select("area_10r").eq("campaign_id",e).neq("status","canceled");return t?(console.error("Error fetching campaign total area:",t),0):r?.reduce((e,r)=>e+(r.area_10r||0),0)||0}async function d(e){try{let{data:r,error:t}=await a.O.from("projects").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",e.campaign_id).single();if(t||!r)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(r))return{success:!1,error:"この案件は募集終了しています"};let i=await l(e.campaign_id),o=Number(r.max_target_area_10r)>0?Number(r.max_target_area_10r):Number(r.target_area_10r)||1,c=(0,n.ae)(e.area_10r,i,o);if(!c.isValid)return{success:!1,error:c.errorMessage??"申込面積が上限を超えています"};let d=s(e.field_polygon),u=`BK_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,m={id:u,campaign_id:e.campaign_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:d,area_10r:e.area_10r,locked_price:e.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=e.farmer_id&&""!==e.farmer_id&&(m.farmer_id=e.farmer_id);let{data:_,error:g}=await a.O.from("bookings").insert(m).select("id").single();if(g)return console.error("Error creating booking:",g),{success:!1,error:g.message};return{success:!0,bookingId:_?.id||u}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function u(e,r){try{let t=s(e.targetAreaPolygon),n=`C_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{data:i,error:o}=await a.O.from("projects").insert({id:n,provider_id:r||null,location:e.location,start_date:e.startDate,end_date:e.endDate,target_crop_id:e.cropId||null,task_category_id:e.categoryId||null,task_detail_id:e.detailId||null,pesticide_name:e.pesticide||null,dilution_rate:e.dilutionRate?parseFloat(e.dilutionRate):null,amount_per_10r:e.amountPer10r?parseFloat(e.amountPer10r):null,base_price:e.basePrice,min_price:e.minPrice,min_target_area_10r:e.minTargetArea10r||null,target_area_10r:e.targetArea10r,max_target_area_10r:e.maxTargetArea10r??e.targetArea10r??null,execution_price:e.executionPrice??null,confirmation_deadline_days:e.confirmationDeadlineDays||null,target_area_polygon:t,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(o)return console.error("Error creating campaign:",o),{success:!1,error:o.message};return{success:!0,campaignId:i?.id||n}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function m(e){let{data:r,error:t}=await a.O.from("projects").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",e).single();if(t||!r)return{success:!1,error:"案件が見つかりません"};let s=await l(e),i={base_price:Number(r.base_price)||0,min_price:Number(r.min_price)||0,target_area_10r:Number(r.target_area_10r)||0,min_target_area_10r:r.min_target_area_10r,max_target_area_10r:r.max_target_area_10r,execution_price:r.execution_price},o=(0,n.Bx)(i,s).currentPrice??(i.min_price||i.base_price)??0,{error:c}=await a.O.from("projects").update({status:"closed",is_closed:!0,final_unit_price:o}).eq("id",e);if(c)return{success:!1,error:c.message};let{error:d}=await a.O.from("bookings").update({locked_price:o}).eq("campaign_id",e).neq("status","canceled");return d?{success:!1,error:d.message}:{success:!0}}},5750:(e,r,t)=>{"use strict";t.d(r,{ts:()=>s,w7:()=>n});var a=t(8704);async function s(){try{let{data:{session:e}}=await a.O.auth.getSession();if(!e)return null;let{data:r,error:t}=await a.O.from("users").select("*").eq("email",e.user.email).single();if(t||!r)return null;return r}catch(e){return console.error("Error getting current user:",e),null}}async function n(){await a.O.auth.signOut(),window.location.href="/login"}},4133:(e,r,t)=>{"use strict";function a(e,r){let{base_price:t,min_price:a,target_area_10r:s,min_target_area_10r:n=0,max_target_area_10r:i,execution_price:o}=e;if(t<a)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return n>0&&i&&i>0&&o?function(e,r){let{base_price:t,min_price:a,min_target_area_10r:s,max_target_area_10r:n,execution_price:i}=e;if(r<s){let e=s-r;return{currentPrice:null,progress:r/s,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=n)return{currentPrice:Math.round(a),progress:1,isUnformed:!1,priceReduction:t-a,remainingArea:0,nextMilestoneArea:0};let o=(r-s)/(n-s),c=i+(a-i)*o,l=n-r;return{currentPrice:Math.round(c),progress:o,isUnformed:!1,priceReduction:t-c,remainingArea:l,nextMilestoneArea:l}}(e,r):function(e,r){let{base_price:t,min_price:a,target_area_10r:s}=e,n=Math.min(r/s,1),i=t-(t-a)*n,o=Math.max(0,s-r);return{currentPrice:Math.round(i),progress:n,isUnformed:!1,priceReduction:t-i,remainingArea:o,nextMilestoneArea:o>0?o:void 0}}(e,r)}function s(e,r,t){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:t-r,maxArea:t};let a=t-r;return e>a?{isValid:!1,errorMessage:`申し込み面積が上限を超えています。残り ${a.toFixed(1)} 反まで予約可能です。`,currentTotalArea:r,remainingArea:a,maxArea:t}:{isValid:!0,currentTotalArea:r,remainingArea:a,maxArea:t}}t.d(r,{Bx:()=>a,ae:()=>s})},8704:(e,r,t)=>{"use strict";t.d(r,{O:()=>a});let a=(0,t(3974).createBrowserClient)("https://ayvieorwnyxxfygbhzny.supabase.co","sb_publishable_saY21TLJVLBNk5lg53j5Pg_PW9RAlEr")},7858:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>g,metadata:()=>_});var a=t(5036),s=t(2574),n=t.n(s),i=t(2255),o=t.n(i);t(5023);let c=(0,t(6843).createProxy)(String.raw`C:\Users\yusuk\Documents\wwx\Wayfinder AgriX\v3-app\src\components\Header.tsx`),{__esModule:l,$$typeof:d}=c,u=c.default;var m=t(7171);let _={title:"Wayfinder AgriX - ドローンあいのり予約",description:"農家と業者をつなぐ農作業予約プラットフォーム"};function g({children:e}){return a.jsx("html",{lang:"ja",children:(0,a.jsxs)("body",{className:`${n().variable} ${o().variable} font-sans antialiased`,children:[a.jsx(u,{}),e,a.jsx(m.x7,{position:"top-center",richColors:!0,closeButton:!0})]})})}},3881:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>s});var a=t(337);let s=e=>[{type:"image/x-icon",sizes:"16x16",url:(0,a.fillMetadataSegment)(".",e.params,"favicon.ico")+""}]},5023:()=>{}};