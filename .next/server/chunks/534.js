"use strict";exports.id=534,exports.ids=[534],exports.modules={3673:(e,r,a)=>{a.d(r,{Ol:()=>o,SZ:()=>d,Zb:()=>i,aY:()=>l,ll:()=>c});var t=a(5344),n=a(3729),s=a(1453);let i=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,s.cn)("rounded-lg border border-border bg-card text-card-foreground shadow-sm",e),...r}));i.displayName="Card";let o=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",e),...r}));o.displayName="CardHeader";let c=n.forwardRef(({className:e,...r},a)=>t.jsx("h3",{ref:a,className:(0,s.cn)("text-lg font-bold leading-none tracking-tight text-card-foreground",e),...r}));c.displayName="CardTitle";let d=n.forwardRef(({className:e,...r},a)=>t.jsx("p",{ref:a,className:(0,s.cn)("text-sm text-muted-foreground",e),...r}));d.displayName="CardDescription";let l=n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,s.cn)("p-6 pt-0",e),...r}));l.displayName="CardContent",n.forwardRef(({className:e,...r},a)=>t.jsx("div",{ref:a,className:(0,s.cn)("flex items-center p-6 pt-0",e),...r})).displayName="CardFooter"},8732:(e,r,a)=>{a.d(r,{dm:()=>_,TB:()=>d,mK:()=>l,Gr:()=>f,xC:()=>u,AK:()=>x,ss:()=>o,x1:()=>c,cd:()=>g,v2:()=>i,xW:()=>m,L4:()=>p});var t=a(8704);function n(e){let r=e.coordinates[0].map(([e,r])=>`${e} ${r}`).join(", ");return`POLYGON((${r}))`}a(1968);var s=a(4133);async function i(){let{data:e,error:r}=await t.O.from("projects").select("*").eq("status","open").eq("is_closed",!1).order("created_at",{ascending:!1});return r?(console.error("Error fetching open campaigns:",r),[]):e||[]}async function o(e){let{data:r,error:a}=await t.O.from("bookings").select("id, campaign_id, area_10r, status, work_status, locked_price, created_at").eq("farmer_id",e).order("created_at",{ascending:!1});if(a)return console.error("Error fetching farmer bookings:",a),[];let n=r||[];if(0===n.length)return[];let s=[...new Set(n.map(e=>e.campaign_id))],{data:i}=await t.O.from("projects").select("id, location, campaign_title, start_date, end_date, status, is_closed").in("id",s),o=new Map;return(i||[]).forEach(e=>{o.set(e.id,{id:e.id,location:e.location||"",campaign_title:e.campaign_title,start_date:e.start_date,end_date:e.end_date,status:e.status,is_closed:e.is_closed})}),n.map(e=>({id:e.id,campaign_id:e.campaign_id,area_10r:Number(e.area_10r)||0,status:e.status||"",work_status:e.work_status,locked_price:null!=e.locked_price?Number(e.locked_price):void 0,created_at:e.created_at,project:o.get(e.campaign_id)}))}async function c(e){let{data:r,error:a}=await t.O.from("bookings").select("area_10r").eq("campaign_id",e).neq("status","canceled");return a?(console.error("Error fetching campaign total area:",a),0):r?.reduce((e,r)=>e+(r.area_10r||0),0)||0}async function d(e){try{let{data:r,error:a}=await t.O.from("projects").select("id, is_closed, status, end_date, max_target_area_10r, target_area_10r").eq("id",e.campaign_id).single();if(a||!r)return{success:!1,error:"案件が見つかりません"};if(function(e){let r=new Date().toISOString().slice(0,10);return!0===e.is_closed||"closed"===String(e.status)||"completed"===String(e.status)||"unformed"===String(e.status)||!!(e.end_date&&String(e.end_date).slice(0,10)<r)}(r))return{success:!1,error:"この案件は募集終了しています"};let i=await c(e.campaign_id),o=Number(r.max_target_area_10r)>0?Number(r.max_target_area_10r):Number(r.target_area_10r)||1,d=(0,s.ae)(e.area_10r,i,o);if(!d.isValid)return{success:!1,error:d.errorMessage??"申込面積が上限を超えています"};let l=n(e.field_polygon),_=`BK_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,u={id:_,campaign_id:e.campaign_id,farmer_name:e.farmer_name,phone:e.phone,email:e.email,desired_start_date:e.desired_start_date,desired_end_date:e.desired_end_date,field_polygon:l,area_10r:e.area_10r,locked_price:e.locked_price,status:"confirmed",work_status:"pending",invoice_status:"unbilled",applied_at:new Date().toISOString()};null!=e.farmer_id&&""!==e.farmer_id&&(u.farmer_id=e.farmer_id);let{data:m,error:g}=await t.O.from("bookings").insert(u).select("id").single();if(g)return console.error("Error creating booking:",g),{success:!1,error:g.message};return{success:!0,bookingId:m?.id||_}}catch(e){return console.error("Unexpected error creating booking:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function l(e,r){try{let a=n(e.targetAreaPolygon),s=`C_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{data:i,error:o}=await t.O.from("projects").insert({id:s,provider_id:r||null,location:e.location,start_date:e.startDate,end_date:e.endDate,target_crop_id:e.cropId||null,task_category_id:e.categoryId||null,task_detail_id:e.detailId||null,pesticide_name:e.pesticide||null,dilution_rate:e.dilutionRate?parseFloat(e.dilutionRate):null,amount_per_10r:e.amountPer10r?parseFloat(e.amountPer10r):null,base_price:e.basePrice,min_price:e.minPrice,min_target_area_10r:e.minTargetArea10r||null,target_area_10r:e.targetArea10r,max_target_area_10r:e.maxTargetArea10r??e.targetArea10r??null,execution_price:e.executionPrice??null,confirmation_deadline_days:e.confirmationDeadlineDays||null,target_area_polygon:a,status:"open",is_closed:!1,created_at:new Date().toISOString()}).select("id").single();if(o)return console.error("Error creating campaign:",o),{success:!1,error:o.message};return{success:!0,campaignId:i?.id||s}}catch(e){return console.error("Unexpected error creating campaign:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function _(e){let{data:r,error:a}=await t.O.from("projects").select("id, base_price, min_price, target_area_10r, min_target_area_10r, max_target_area_10r, execution_price").eq("id",e).single();if(a||!r)return{success:!1,error:"案件が見つかりません"};let n=await c(e),i={base_price:Number(r.base_price)||0,min_price:Number(r.min_price)||0,target_area_10r:Number(r.target_area_10r)||0,min_target_area_10r:r.min_target_area_10r,max_target_area_10r:r.max_target_area_10r,execution_price:r.execution_price},o=(0,s.Bx)(i,n).currentPrice??(i.min_price||i.base_price)??0,{error:d}=await t.O.from("projects").update({status:"closed",is_closed:!0,final_unit_price:o}).eq("id",e);if(d)return{success:!1,error:d.message};let{error:l}=await t.O.from("bookings").update({locked_price:o}).eq("campaign_id",e).neq("status","canceled");return l?{success:!1,error:l.message}:{success:!0}}async function u(e){try{let r=`WR_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{data:a,error:n}=await t.O.from("work_requests").insert({id:r,farmer_id:e.farmer_id,location:e.location||null,crop_name_free_text:e.crop_name_free_text||null,task_category_free_text:e.task_category_free_text||null,task_detail_free_text:e.task_detail_free_text||null,desired_start_date:e.desired_start_date||null,desired_end_date:e.desired_end_date||null,estimated_area_10r:e.estimated_area_10r??null,desired_price:e.desired_price??null,notes:e.notes||null,status:"pending"}).select("id").single();if(n)return console.error("Error creating work request:",n),{success:!1,error:n.message};return{success:!0,requestId:a?.id??r}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e){let{data:r,error:a}=await t.O.from("work_requests").select("*").eq("farmer_id",e).order("created_at",{ascending:!1});return a?(console.error("Error fetching work requests:",a),[]):r||[]}async function g(e){let{data:r,error:a}=await t.O.from("fields").select("*").eq("farmer_id",e).order("created_at",{ascending:!1});return a?(console.error("Error fetching fields:",a),[]):r||[]}async function f(e){try{let r=`F_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{data:a,error:n}=await t.O.from("fields").insert({id:r,farmer_id:e.farmer_id,name:e.name||null,address:e.address||null,area_size:e.area_size??null,lat:e.lat??null,lng:e.lng??null}).select("id").single();if(n)return console.error("Error creating field:",n),{success:!1,error:n.message};return{success:!0,fieldId:a?.id??r}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function p(e,r){let a={};void 0!==r.name&&(a.name=r.name),void 0!==r.address&&(a.address=r.address),void 0!==r.area_size&&(a.area_size=r.area_size),void 0!==r.lat&&(a.lat=r.lat),void 0!==r.lng&&(a.lng=r.lng);let{error:n}=await t.O.from("fields").update(a).eq("id",e);return n?(console.error("Error updating field:",n),{success:!1,error:n.message}):{success:!0}}async function x(e){let{error:r}=await t.O.from("fields").delete().eq("id",e);return r?(console.error("Error deleting field:",r),{success:!1,error:r.message}):{success:!0}}},4133:(e,r,a)=>{function t(e,r){let{base_price:a,min_price:t,target_area_10r:n,min_target_area_10r:s=0,max_target_area_10r:i,execution_price:o}=e;if(a<t)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return s>0&&i&&i>0&&o?function(e,r){let{base_price:a,min_price:t,min_target_area_10r:n,max_target_area_10r:s,execution_price:i}=e;if(r<n){let e=n-r;return{currentPrice:null,progress:r/n,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=s)return{currentPrice:Math.round(t),progress:1,isUnformed:!1,priceReduction:a-t,remainingArea:0,nextMilestoneArea:0};let o=(r-n)/(s-n),c=i+(t-i)*o,d=s-r;return{currentPrice:Math.round(c),progress:o,isUnformed:!1,priceReduction:a-c,remainingArea:d,nextMilestoneArea:d}}(e,r):function(e,r){let{base_price:a,min_price:t,target_area_10r:n}=e,s=Math.min(r/n,1),i=a-(a-t)*s,o=Math.max(0,n-r);return{currentPrice:Math.round(i),progress:s,isUnformed:!1,priceReduction:a-i,remainingArea:o,nextMilestoneArea:o>0?o:void 0}}(e,r)}function n(e,r,a){if(e<=0)return{isValid:!1,errorMessage:"申込面積は1反以上である必要があります",currentTotalArea:r,remainingArea:a-r,maxArea:a};let t=a-r;return e>t?{isValid:!1,errorMessage:`申し込み面積が上限を超えています。残り ${t.toFixed(1)} 反まで予約可能です。`,currentTotalArea:r,remainingArea:t,maxArea:a}:{isValid:!0,currentTotalArea:r,remainingArea:t,maxArea:a}}a.d(r,{Bx:()=>t,ae:()=>n})}};