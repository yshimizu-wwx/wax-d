"use strict";(()=>{var e={};e.id=227,e.ids=[227],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9085:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>b,originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var s={};t.r(s),t.d(s,{POST:()=>d});var i=t(5419),a=t(9108),n=t(9678),o=t(8070),u=t(2509),c=t(1498);let l="evidence";async function p(e,r,t){try{if(!r.bookingId||null==r.actualArea10r||r.actualArea10r<0)return{success:!1,message:"申込IDと実績面積は必須です"};let{data:s,error:i}=await e.from("bookings").select("id, campaign_id, farmer_id, area_10r").eq("id",r.bookingId).single();if(i||!s)return{success:!1,message:"申込が見つかりません"};let{data:a,error:n}=await e.from("campaigns").select("id, provider_id, final_unit_price, base_price, dilution_rate, amount_per_10r").eq("id",s.campaign_id).single();if(n||!a||a.provider_id!==t)return{success:!1,message:"案件が見つからないか、権限がありません"};let{data:o}=await e.from("work_reports").select("id").eq("application_id",r.bookingId).maybeSingle();if(o)return{success:!1,message:"この申込は既に実績報告済みです（1農家1報告）"};let u=Number(a.final_unit_price)||Number(a.base_price)||0,p=(0,c.MR)(u,r.actualArea10r),d="";if(r.imageBase64&&r.mimeType){let s=r.mimeType.split("/")[1]||"jpg",i=`work_${r.bookingId}_${Date.now()}.${s}`,a=`${t}/${i}`,n=Buffer.from(r.imageBase64,"base64"),{error:o}=await e.storage.from(l).upload(a,n,{contentType:r.mimeType,upsert:!1});if(!o){let{data:r}=e.storage.from(l).getPublicUrl(a);d=r?.publicUrl??""}}let{error:m}=await e.from("bookings").update({actual_area_10r:r.actualArea10r,work_status:"completed",final_amount:p,...d&&{evidence_image_url:d}}).eq("id",r.bookingId);if(m)return{success:!1,message:"申込の更新に失敗しました: "+m.message};let g="WRP_"+Date.now(),{error:f}=await e.from("work_reports").insert({id:g,application_id:r.bookingId,campaign_id:s.campaign_id,dilution_rate_actual:String(a.dilution_rate??""),amount_actual_per_10r:String(a.amount_per_10r??""),photo_urls_json:d?JSON.stringify([d]):"",reported_at:new Date().toISOString(),reporter_id:t,gps_lat:r.gps?.lat??null,gps_lng:r.gps?.lng??null,reported_at_iso:new Date().toISOString()});if(f)return{success:!1,message:"実績報告の保存に失敗しました: "+f.message};return{success:!0,reportId:g,finalAmount:p}}catch(e){return console.error("Report submit error:",e),{success:!1,message:"サーバーエラー"}}}async function d(e){try{let r=await (0,u.e)(),{data:{session:t}}=await r.auth.getSession();if(!t?.user?.email)return o.Z.json({success:!1,message:"未ログインです"},{status:401});let s=await r.from("users").select("id, role").eq("email",t.user.email).single();if(!s.data)return o.Z.json({success:!1,message:"権限がありません"},{status:403});let i=s.data;if("provider"!==i.role)return o.Z.json({success:!1,message:"権限がありません"},{status:403});let a=await e.json(),n=await p(r,a,i.id);if(!n.success){let e="申込が見つかりません"===n.message||"案件が見つからないか、権限がありません"===n.message?404:"申込IDと実績面積は必須です"===n.message||"この申込は既に実績報告済みです（1農家1報告）"===n.message?400:500;return o.Z.json({success:!1,message:n.message},{status:e})}return o.Z.json({success:!0,reportId:n.reportId,finalAmount:n.finalAmount})}catch(e){return console.error("Report submit error:",e),o.Z.json({success:!1,message:"サーバーエラー"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/provider/reports/submit/route",pathname:"/api/provider/reports/submit",filename:"route",bundlePath:"app/api/provider/reports/submit/route"},resolvedPagePath:"C:\\Users\\yusuk\\Documents\\wwx\\Wayfinder AgriX\\v3-app\\src\\app\\api\\provider\\reports\\submit\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:_,headerHooks:b,staticGenerationBailout:w}=m,h="/api/provider/reports/submit/route";function I(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},1498:(e,r,t)=>{function s(e,r){let{base_price:t,min_price:s,target_area_10r:i,min_target_area_10r:a=0,max_target_area_10r:n,execution_price:o}=e;if(t<s)throw Error("開始単価は目標単価以上である必要があります");if(r<0)throw Error("申込合計面積は0以上である必要があります");return a>0&&n&&n>0&&o?function(e,r){let{base_price:t,min_price:s,min_target_area_10r:i,max_target_area_10r:a,execution_price:n}=e;if(r<i){let e=i-r;return{currentPrice:null,progress:r/i,isUnformed:!0,priceReduction:0,remainingArea:e,nextMilestoneArea:e}}if(r>=a)return{currentPrice:Math.round(s),progress:1,isUnformed:!1,priceReduction:t-s,remainingArea:0,nextMilestoneArea:0};let o=(r-i)/(a-i),u=n+(s-n)*o,c=a-r;return{currentPrice:Math.round(u),progress:o,isUnformed:!1,priceReduction:t-u,remainingArea:c,nextMilestoneArea:c}}(e,r):function(e,r){let{base_price:t,min_price:s,target_area_10r:i}=e,a=Math.min(r/i,1),n=t-(t-s)*a,o=Math.max(0,i-r);return{currentPrice:Math.round(n),progress:a,isUnformed:!1,priceReduction:t-n,remainingArea:o,nextMilestoneArea:o>0?o:void 0}}(e,r)}function i(e,r){if(e<0||r<0)throw Error("単価と実績面積は0以上である必要があります");return Math.round(e*r)}function a(e,r=10){if(e<0)throw Error("税抜金額は0以上である必要があります");if(r<0||r>100)throw Error("消費税率は0〜100%の範囲である必要があります");let t=Math.round(r/100*e);return{amountExTax:e,taxAmount:t,amountInclusive:e+t,taxRate:r}}t.d(r,{Bx:()=>s,MR:()=>i,km:()=>a})},2509:(e,r,t)=>{t.d(r,{e:()=>a});var s=t(6496),i=t(7439);async function a(){let e=await (0,i.cookies)();return(0,s.createServerClient)("https://ayvieorwnyxxfygbhzny.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dmllb3J3bnl4eGZ5Z2Joem55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjY1OTUsImV4cCI6MjA4NjQwMjU5NX0.-alPp1Cr1J2yoKcdaln4LMbOPjaGCb4wRjURGhibLPk",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:s})=>{t?e.set(r,t,s):e.delete(r)})}catch{}}}})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,744],()=>t(9085));module.exports=s})();