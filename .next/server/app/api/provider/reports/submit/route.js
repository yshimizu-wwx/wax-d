"use strict";(()=>{var e={};e.id=227,e.ids=[227],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9427:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{POST:()=>c});var a=r(5419),i=r(9108),o=r(9678),n=r(8070),u=r(2509);let l="evidence";async function c(e){try{let t=await (0,u.e)(),{data:{session:r}}=await t.auth.getSession();if(!r?.user?.email)return n.Z.json({success:!1,message:"未ログインです"},{status:401});let s=await t.from("users").select("id, role").eq("email",r.user.email).single();if(!s.data||"provider"!==s.data.role)return n.Z.json({success:!1,message:"権限がありません"},{status:403});let a=s.data.id,{bookingId:i,actualArea10r:o,imageBase64:c,mimeType:p,gps:d}=await e.json();if(!i||null==o||o<0)return n.Z.json({success:!1,message:"申込IDと実績面積は必須です"},{status:400});let{data:m,error:g}=await t.from("bookings").select("id, campaign_id, farmer_id, area_10r").eq("id",i).single();if(g||!m)return n.Z.json({success:!1,message:"申込が見つかりません"},{status:404});let{data:_,error:f}=await t.from("projects").select("id, provider_id, final_unit_price, base_price, dilution_rate, amount_per_10r").eq("id",m.campaign_id).single();if(f||!_||_.provider_id!==a)return n.Z.json({success:!1,message:"案件が見つからないか、権限がありません"},{status:404});let{data:w}=await t.from("work_reports").select("id").eq("application_id",i).maybeSingle();if(w)return n.Z.json({success:!1,message:"この申込は既に実績報告済みです（1農家1報告）"},{status:400});let b=Number(_.final_unit_price)||Number(_.base_price)||0,v=Math.round(o*b),j="";if(c&&p){let e=p.split("/")[1]||"jpg",r=`work_${i}_${Date.now()}.${e}`,s=`${a}/${r}`,o=Buffer.from(c,"base64"),{error:n}=await t.storage.from(l).upload(s,o,{contentType:p,upsert:!1});if(!n){let{data:e}=t.storage.from(l).getPublicUrl(s);j=e?.publicUrl??""}}let{error:h}=await t.from("bookings").update({actual_area_10r:o,work_status:"completed",final_amount:v,...j&&{evidence_image_url:j}}).eq("id",i);if(h)return n.Z.json({success:!1,message:"申込の更新に失敗しました: "+h.message},{status:500});let x="WRP_"+Date.now(),{error:y}=await t.from("work_reports").insert({id:x,application_id:i,campaign_id:m.campaign_id,dilution_rate_actual:_.dilution_rate??"",amount_actual_per_10r:_.amount_per_10r??"",photo_urls_json:j?JSON.stringify([j]):"",reported_at:new Date().toISOString(),reporter_id:a,gps_lat:d?.lat??null,gps_lng:d?.lng??null,reported_at_iso:new Date().toISOString()});if(y)return n.Z.json({success:!1,message:"実績報告の保存に失敗しました: "+y.message},{status:500});return n.Z.json({success:!0,reportId:x,finalAmount:v})}catch(e){return console.error("Report submit error:",e),n.Z.json({success:!1,message:"サーバーエラー"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/provider/reports/submit/route",pathname:"/api/provider/reports/submit",filename:"route",bundlePath:"app/api/provider/reports/submit/route"},resolvedPagePath:"C:\\Users\\yusuk\\Documents\\wwx\\Wayfinder AgriX\\v3-app\\src\\app\\api\\provider\\reports\\submit\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:_,staticGenerationBailout:f}=p,w="/api/provider/reports/submit/route";function b(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},2509:(e,t,r)=>{r.d(t,{e:()=>i});var s=r(6496),a=r(7439);async function i(){let e=await (0,a.cookies)();return(0,s.createServerClient)("https://ayvieorwnyxxfygbhzny.supabase.co","sb_publishable_saY21TLJVLBNk5lg53j5Pg_PW9RAlEr",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>{r?e.set(t,r,s):e.delete(t)})}catch{}}}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,744],()=>r(9427));module.exports=s})();