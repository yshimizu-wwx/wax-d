"use strict";(()=>{var e={};e.id=129,e.ids=[129],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6467:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>w,originalPathname:()=>N,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>b});var s={};a.r(s),a.d(s,{GET:()=>m});var r=a(5419),n=a(9108),o=a(9678),i=a(8070),l=a(4480);function c(e){let t=e.trim();return!!(/日本|Japan|にほん|ニホン/i.test(t)||/[一-龥ぁ-んァ-ン]/.test(t)||/県|府|都|道|郡|町|村|市|区|丁目|番地/.test(t))}function d(e){let t=e.trim();return!c(t)||/日本|Japan/i.test(t)?t:`${t}, Japan`}async function u(e){let t=e?.trim();if(!t)return null;let a=t.replace(/(\d)\s*[－ー]\s*(\d)/g,"$1-$2");fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"geocode.ts",message:"geocodeAddress backend",data:{hasGoogle:!0},timestamp:Date.now(),hypothesisId:"H5_backend"})}).catch(()=>{});try{let e=await (0,l.X)(a);if(e)return{lat:e.lat,lng:e.lng,displayName:e.displayName}}catch{}let s=d(a),r=new URLSearchParams({q:s,format:"json",limit:"1",addressdetails:"0"});r.set("countrycodes","jp"),fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"geocode.ts",message:"Nominatim first attempt",data:{queryLength:s.length},timestamp:Date.now(),hypothesisId:"H7_nominatim"})}).catch(()=>{});let n=async()=>{let e=await fetch(`https://nominatim.openstreetmap.org/search?${r.toString()}`,{method:"GET",headers:{Accept:"application/json","User-Agent":"WayfinderAgriX/1.0 (Agricultural field mapping)"}});if(!e.ok)return null;let t=await e.json();if(!Array.isArray(t)||0===t.length)return null;let a=t[0],s=parseFloat(a.lat),n=parseFloat(a.lon);return Number.isNaN(s)||Number.isNaN(n)?null:{lat:s,lng:n,displayName:a.display_name}},o=await n();if(fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"geocode.ts",message:"Nominatim first result",data:{hasResult:!!o},timestamp:Date.now(),hypothesisId:"H7_nominatim"})}).catch(()=>{}),o||s===a||(r.set("q",a),await new Promise(e=>setTimeout(e,1100)),o=await n()),!o&&c(a)){let e=a.replace(/\s*[\d０-９\-－ー]+\s*$/,"").trim();e&&e.length>=2&&(r.set("q",d(e)),await new Promise(e=>setTimeout(e,1100)),o=await n())}if(!o&&/^利根郡/.test(a)&&(r.set("q",d(`群馬県${a}`)),await new Promise(e=>setTimeout(e,1100)),!(o=await n()))){let e=a.replace(/\s*[\d０-９\-－ー]+\s*$/,"").trim();e.length>=2&&(r.set("q",d(`群馬県${e}`)),await new Promise(e=>setTimeout(e,1100)),o=await n())}return!o&&/月夜野/.test(a)&&(r.set("q","月夜野, 群馬県, Japan"),await new Promise(e=>setTimeout(e,1100)),o=await n()),!o&&/みなかみ/.test(a)&&(r.set("q","みなかみ町, 群馬県, Japan"),await new Promise(e=>setTimeout(e,1100)),o=await n()),o}async function p(e,t){if("number"!=typeof e||"number"!=typeof t||Number.isNaN(e)||Number.isNaN(t))return null;try{let{reverseGeocodeWithGoogle:s}=await Promise.resolve().then(a.bind(a,4480));return s(e,t)}catch{}return null}async function m(e){fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"api/geocode/route.ts",message:"GET handler entered",data:{pathname:e.nextUrl.pathname},timestamp:Date.now(),hypothesisId:"H2_route_hit"})}).catch(()=>{});let t=e.nextUrl.searchParams.get("address"),a=e.nextUrl.searchParams.get("lat"),s=e.nextUrl.searchParams.get("lng");if(null!=a&&null!=s){let e=parseFloat(a),t=parseFloat(s);if(Number.isNaN(e)||Number.isNaN(t))return i.Z.json({error:"lat, lng は数値で指定してください"},{status:400});try{let a=await p(e,t);if(!a)return i.Z.json({error:"住所が見つかりませんでした"},{status:404});return i.Z.json({lat:a.lat,lng:a.lng,displayName:a.displayName})}catch(e){return console.error("[geocode reverse]",e),i.Z.json({error:"検索に失敗しました"},{status:500})}}if(!t?.trim())return i.Z.json({error:"address を指定するか、lat と lng を指定してください"},{status:400});let r=t.trim();fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"api/geocode/route.ts",message:"before geocodeAddress",data:{addressLength:r.length},timestamp:Date.now(),hypothesisId:"H3_params"})}).catch(()=>{});try{let e=await u(r);if(fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"api/geocode/route.ts",message:"after geocodeAddress",data:{hasResult:!!e},timestamp:Date.now(),hypothesisId:"H3_geocode_result"})}).catch(()=>{}),!e)return i.Z.json({error:"住所が見つかりませんでした"},{status:404});return i.Z.json({lat:e.lat,lng:e.lng,displayName:e.displayName})}catch(e){return fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"api/geocode/route.ts",message:"geocodeAddress threw",data:{error:String(e.message)},timestamp:Date.now(),hypothesisId:"H4_throw"})}).catch(()=>{}),console.error("[geocode]",e),i.Z.json({error:"検索に失敗しました"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/geocode/route",pathname:"/api/geocode",filename:"route",bundlePath:"app/api/geocode/route"},resolvedPagePath:"C:\\Users\\yusuk\\Documents\\wwx\\Wayfinder AgriX\\v3-app\\src\\app\\api\\geocode\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y,headerHooks:w,staticGenerationBailout:b}=h,N="/api/geocode/route";function S(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},4480:(e,t,a)=>{a.d(t,{X:()=>n,reverseGeocodeWithGoogle:()=>o});let s="https://maps.googleapis.com/maps/api/geocode/json";function r(e){if("OK"!==e.status&&"ZERO_RESULTS"!==e.status||!e.results?.length)return null;let t=e.results[0],a=t.geometry?.location;return a&&"number"==typeof a.lat&&"number"==typeof a.lng?{lat:a.lat,lng:a.lng,displayName:t.formatted_address}:null}async function n(e){let t="AIzaSyAU72mFnbq_Pc3_RJDJXZ7SEUKkZMPL1Ug";if(!t?.trim())return null;let a=e?.trim();if(!a)return null;let n=a.replace(/(\d)\s*[－ー]\s*(\d)/g,"$1-$2"),o=async e=>{try{let a=new URLSearchParams({address:e,key:t,region:"jp",language:"ja"}),n=await fetch(`${s}?${a.toString()}`);if(!n.ok)return null;let o=await n.json();if(fetch("http://127.0.0.1:7245/ingest/18abc857-b9fe-472f-879d-ab424fec0177",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"google-maps.ts",message:"Google geocode response",data:{status:o?.status,resultsCount:o?.results?.length??0},timestamp:Date.now(),hypothesisId:"H6_google_response"})}).catch(()=>{}),o?.status==="REQUEST_DENIED")throw Error("GOOGLE_REQUEST_DENIED");return r(o)}catch(e){if(e?.message==="GOOGLE_REQUEST_DENIED")throw e;return null}};try{let e=await o(n);if(!e&&(/[一-龥ぁ-んァ-ン]/.test(n)||/県|府|都|道|郡|町|村|市|区/.test(n))&&!/日本|Japan/i.test(n)&&(e=await o(`${n}, 日本`)),!(!e&&/^利根郡/.test(n))||(e=await o(`群馬県${n}`))||(e=await o(`群馬県${n}, 日本`)),!e){let t=n.replace(/\s*[\d０-９\-－ー]+\s*$/,"").trim();!(t.length>=2)||t===n||(e=await o(t))||/日本|Japan/i.test(t)||(e=await o(`${t}, 日本`))}return e}catch(e){if(e?.message==="GOOGLE_REQUEST_DENIED")return null;throw e}}async function o(e,t){let a="AIzaSyAU72mFnbq_Pc3_RJDJXZ7SEUKkZMPL1Ug";if(!a?.trim())return null;try{let n=new URLSearchParams({latlng:`${e},${t}`,key:a,language:"ja"}),o=await fetch(`${s}?${n.toString()}`);if(!o.ok)return null;let i=await o.json();return r(i)}catch{return null}}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[638,206],()=>a(6467));module.exports=s})();